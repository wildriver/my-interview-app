<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Interview Setup (Groq)</title>
    <style>
        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
            height: 100vh;
            overflow: hidden;
        }

        .layout-container {
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 15px;
            padding: 15px;
            height: 100vh;
            box-sizing: border-box;
        }

        .col {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .col-header {
            padding: 12px 20px;
            border-bottom: 1px solid #eee;
            background: #fafafa;
            font-weight: bold;
            color: #2c3e50;
            flex-shrink: 0;
            font-size: 0.95em;
        }

        .col-content {
            padding: 15px;
            overflow-y: auto;
            flex-grow: 1;
        }

        /* Settings 3-column grid */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1.3fr;
            gap: 20px;
        }

        .settings-col {
            display: flex;
            flex-direction: column;
        }

        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 4px;
            font-size: 0.85em;
            color: #34495e;
        }

        .help-text {
            font-size: 0.75em;
            color: #7f8c8d;
            margin-top: 2px;
            margin-bottom: 5px;
        }

        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 6px;
            font-size: 13px;
            box-sizing: border-box;
        }

        textarea {
            resize: vertical;
        }

        /* æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆç”¨ */
        .char-counter {
            float: right;
            font-weight: normal;
            font-size: 0.85em;
            color: #666;
        }

        .char-over {
            color: #dc3545;
            font-weight: bold;
        }

        .range-wrap {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
        }

        input[type="range"] {
            flex: 1;
            cursor: pointer;
        }

        .range-val {
            width: 30px;
            text-align: right;
            font-weight: bold;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: #f55036;
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 15px;
        }

        .btn:hover {
            background-color: #d43f29;
        }

        .btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        .btn-preview {
            display: inline-block;
            padding: 6px 12px;
            background-color: #e9ecef;
            color: #333;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 0.8em;
            cursor: pointer;
            text-align: center;
        }

        .btn-preview:hover {
            background-color: #dde2e6;
        }

        .radio-group label {
            display: inline-block;
            margin-right: 8px;
            font-weight: normal;
            cursor: pointer;
            font-size: 0.85em;
        }

        .status-indicator {
            font-size: 0.8em;
            margin-left: 5px;
        }

        .status-ok {
            color: #28a745;
        }

        .status-err {
            color: #dc3545;
        }

        .status-loading {
            color: #e67e22;
        }

        /* Bottom pane: history list + detail */
        .bottom-pane {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 15px;
            min-height: 0;
        }

        /* å±¥æ­´ãƒ»è©³ç´° */
        .history-empty {
            text-align: center;
            color: #999;
            padding: 30px 15px;
        }

        .history-empty-icon {
            font-size: 2.5em;
            margin-bottom: 8px;
        }

        .history-item {
            padding: 10px 12px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-item:hover {
            background-color: #f0f8ff;
            border-color: #007bff;
        }

        .history-item.active {
            background-color: #fff0ee;
            border-color: #f55036;
        }

        .history-date {
            font-size: 0.7em;
            color: #888;
            margin-bottom: 2px;
        }

        .history-title {
            font-weight: bold;
            font-size: 0.85em;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* è©³ç´°è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .detail-placeholder {
            text-align: center;
            color: #999;
            margin-top: 60px;
            font-size: 0.9em;
        }

        .detail-placeholder-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .detail-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .detail-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #f55036;
        }

        .detail-meta {
            font-size: 0.8em;
            color: #666;
            margin-top: 3px;
        }

        .detail-section-title {
            font-weight: bold;
            margin: 15px 0 8px 0;
            color: #444;
            border-left: 4px solid #28a745;
            padding-left: 8px;
            font-size: 0.9em;
        }

        .detail-summary {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 8px;
            line-height: 1.6;
            white-space: pre-wrap;
            font-size: 0.9em;
        }

        .detail-chat {
            font-size: 0.85em;
        }

        .chat-row {
            margin-bottom: 6px;
            padding: 6px 8px;
            border-radius: 6px;
        }

        .chat-role {
            font-weight: bold;
            font-size: 0.75em;
            margin-bottom: 2px;
        }

        .chat-user {
            background-color: #e3f2fd;
        }

        .chat-ai {
            background-color: #fff0ee;
        }

        /* è¨­å®šæƒ…å ±è¡¨ç¤º */
        .settings-info {
            background: #f0f7ff;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.85em;
            margin-bottom: 8px;
        }

        .setting-row {
            margin-bottom: 4px;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .setting-label {
            font-weight: bold;
            color: #555;
            min-width: 60px;
            font-size: 0.9em;
        }

        .setting-text {
            background: #fff;
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 0.85em;
            color: #666;
            margin-top: 2px;
            width: 100%;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .btn-apply-settings {
            background: #007bff;
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .btn-apply-settings:hover {
            background: #0056b3;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75em;
            margin-top: 5px;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .btn-generate {
            background: #6f42c1;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7em;
        }

        .btn-generate:hover {
            background: #5a32a3;
        }

        .btn-generate:disabled {
            background: #aaa;
            cursor: not-allowed;
        }

        /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ« */
        .section-title {
            font-weight: bold;
            font-size: 0.9em;
            color: #333;
            margin: 0 0 10px 0;
            padding: 6px 8px;
            background: #f0f0f0;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }

        /* AIäººæ ¼é¸æŠ */
        .persona-options {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: 4px;
        }

        .persona-option {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .persona-option:hover {
            background: #f5f5f5;
        }

        .persona-option:has(input:checked) {
            background: #e8f4fd;
            border-color: #007bff;
        }

        .persona-option input {
            margin: 0;
        }

        .persona-label {
            font-weight: bold;
            font-size: 0.8em;
            min-width: 80px;
        }

        .persona-desc {
            font-size: 0.75em;
            color: #666;
        }

        /* ãƒ¢ãƒ‡ãƒ«é¸æŠãƒ†ãƒ¼ãƒ–ãƒ« */
        .model-options {
            display: flex;
            flex-direction: column;
            gap: 3px;
            margin-top: 4px;
            max-height: 280px;
            overflow-y: auto;
        }

        .model-option {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border: 1px solid #eee;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .model-option:hover {
            background: #f5f5f5;
        }

        .model-option:has(input:checked) {
            background: #e8f4fd;
            border-color: #007bff;
        }

        .model-option input {
            margin: 0;
        }

        .model-name {
            flex: 1;
            font-weight: bold;
            font-size: 0.8em;
        }

        .model-tag {
            font-size: 0.65em;
            color: #fff;
            padding: 1px 5px;
            border-radius: 8px;
            white-space: nowrap;
        }

        .tag-fast { background: #28a745; }
        .tag-mid { background: #17a2b8; }
        .tag-quality { background: #6f42c1; }

        .model-limit {
            font-size: 0.75em;
            color: #888;
            min-width: 70px;
            text-align: right;
        }

        /* ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¡¨ç¤ºãƒœã‚¿ãƒ³ */
        .btn-show-prompt {
            background: #6c757d;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7em;
            margin-left: 8px;
        }

        .btn-show-prompt:hover {
            background: #5a6268;
        }

        /* ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« */
        .prompt-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .prompt-modal.active {
            display: flex;
        }

        .prompt-modal-content {
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 0.85em;
            padding: 20px;
            border-radius: 12px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            width: 90%;
        }

        .prompt-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        .prompt-modal-title {
            color: #ffd700;
            font-weight: bold;
        }

        .prompt-modal-close {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .prompt-section {
            margin-bottom: 15px;
        }

        .prompt-section-title {
            color: #aaa;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .prompt-content {
            background: #2a2a2a;
            padding: 10px;
            border-radius: 6px;
            white-space: pre-wrap;
            word-break: break-word;
            color: #7fdbff;
            max-height: 200px;
            overflow-y: auto;
        }

        .prompt-content.response {
            color: #98fb98;
        }

        .prompt-messages {
            color: #ff6b6b;
        }

        /* STT test result */
        .stt-test-result {
            font-size: 0.8em;
            padding: 6px 10px;
            border-radius: 6px;
            margin-top: 5px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }

        @media (max-width: 1100px) {
            .layout-container {
                grid-template-rows: auto;
                height: auto;
                overflow: auto;
            }

            body {
                height: auto;
                overflow: auto;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }

            .bottom-pane {
                grid-template-columns: 1fr;
            }

            .col {
                min-height: 400px;
            }
        }
    </style>
    <!-- OGPåŸºæœ¬è¨­å®š -->
    <meta property="og:title" content="AI Interviewer">
    <meta property="og:description" content="AIã«ã‚ˆã‚‹éŸ³å£°ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ—ãƒª">
    <meta property="og:image" content="https://github.com/wildriver/my-interview-app/blob/main/ogp.png">
    <meta property="og:url" content="https://github.com/wildriver/my-interview-app/">
    <meta property="og:type" content="website">

    <!-- Twitterç”¨ï¼ˆä»»æ„ï¼‰ -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://github.com/wildriver/my-interview-app/blob/main/ogp.png">
</head>

<body>

    <!-- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="prompt-modal" class="prompt-modal" onclick="closePromptModal(event)">
        <div class="prompt-modal-content" onclick="event.stopPropagation()">
            <div class="prompt-modal-header">
                <span class="prompt-modal-title">ğŸ› ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè©³ç´°</span>
                <button class="prompt-modal-close" onclick="closePromptModal()">é–‰ã˜ã‚‹</button>
            </div>
            <div id="prompt-modal-body"></div>
        </div>
    </div>

    <div class="layout-container">

        <!-- ===== ä¸Šæ®µ: è¨­å®š (3ã‚«ãƒ©ãƒ ) ===== -->
        <div class="col">
            <div class="col-header">ğŸ›  ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼è¨­å®š</div>
            <div class="col-content">
                <div class="settings-grid">

                    <!-- === å·¦ã‚«ãƒ©ãƒ : AIã®è¨­å®š === -->
                    <div class="settings-col">
                        <div class="section-title">ğŸ¤– AIã®è¨­å®š</div>

                        <div class="form-group">
                            <label>
                                Groq API Key
                                <a href="https://console.groq.com/keys" target="_blank"
                                    style="font-size: 0.85em; margin-left: 8px;">[å–å¾—]</a>
                                <span id="api-status" class="status-indicator"></span>
                            </label>
                            <input type="text" id="apiKey" placeholder="gsk_..." onblur="validateApi()">
                            <label style="font-size: 0.8em; margin-top: 4px; display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="saveApiKey"> ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã™ã‚‹
                            </label>
                        </div>

                        <div class="form-group">
                            <label>AIã®ãƒ¢ãƒ‡ãƒ«
                                <button type="button" class="btn-generate" onclick="checkRateLimits()" id="checkLimitsBtn">ğŸ”„ æ®‹é‡ãƒã‚§ãƒƒã‚¯</button>
                                <span id="limits-status" style="font-size: 0.75em; color: #666;"></span>
                            </label>
                            <div class="model-options">
                                <label class="model-option">
                                    <input type="radio" name="modelName" value="llama-3.1-8b-instant" checked>
                                    <span class="model-name">Llama 3.1 8B Instant</span>
                                    <span class="model-tag tag-fast">æœ€é€Ÿ</span>
                                    <span class="model-limit" id="limit-0"></span>
                                </label>
                                <label class="model-option">
                                    <input type="radio" name="modelName" value="openai/gpt-oss-20b">
                                    <span class="model-name">GPT-OSS 20B</span>
                                    <span class="model-tag tag-mid">é«˜é€Ÿ</span>
                                    <span class="model-limit" id="limit-1"></span>
                                </label>
                                <label class="model-option">
                                    <input type="radio" name="modelName" value="meta-llama/llama-4-maverick-17b-128e-instruct">
                                    <span class="model-name">Llama 4 Maverick 17B</span>
                                    <span class="model-tag tag-mid">é«˜é€Ÿ</span>
                                    <span class="model-limit" id="limit-2"></span>
                                </label>
                                <label class="model-option">
                                    <input type="radio" name="modelName" value="meta-llama/llama-4-scout-17b-16e-instruct">
                                    <span class="model-name">Llama 4 Scout 17B</span>
                                    <span class="model-limit" id="limit-3"></span>
                                </label>
                                <label class="model-option">
                                    <input type="radio" name="modelName" value="qwen/qwen3-32b">
                                    <span class="model-name">Qwen3 32B</span>
                                    <span class="model-limit" id="limit-4"></span>
                                </label>
                                <label class="model-option">
                                    <input type="radio" name="modelName" value="llama-3.3-70b-versatile">
                                    <span class="model-name">Llama 3.3 70B</span>
                                    <span class="model-tag tag-quality">é«˜å“è³ª</span>
                                    <span class="model-limit" id="limit-5"></span>
                                </label>
                                <label class="model-option">
                                    <input type="radio" name="modelName" value="openai/gpt-oss-120b">
                                    <span class="model-name">GPT-OSS 120B</span>
                                    <span class="model-tag tag-quality">é«˜å“è³ª</span>
                                    <span class="model-limit" id="limit-6"></span>
                                </label>
                                <label class="model-option">
                                    <input type="radio" name="modelName" value="moonshotai/kimi-k2-instruct-0905">
                                    <span class="model-name">Kimi K2 Instruct</span>
                                    <span class="model-limit" id="limit-7"></span>
                                </label>
                            </div>
                            <p class="help-text">å¤§ããªãƒ¢ãƒ‡ãƒ«ã»ã©ç„¡æ–™APIæ ãŒå°‘ãªã„ã€‚æ®‹é‡ãƒã‚§ãƒƒã‚¯ã¯å„ãƒ¢ãƒ‡ãƒ«ã«1ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¶ˆè²»ã—ã¾ã™ã€‚</p>
                        </div>

                        <div class="form-group">
                            <label>ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼AIã®æ€§æ ¼</label>
                            <div class="persona-options">
                                <label class="persona-option">
                                    <input type="radio" name="personaType" value="listener" checked>
                                    <span class="persona-label">ğŸ§ å‚¾è´å‹</span>
                                    <span class="persona-desc">æœ¬éŸ³ã‚’å¼•ãå‡ºã™ã‚«ã‚¦ãƒ³ã‚»ãƒ©ãƒ¼é¢¨</span>
                                </label>
                                <label class="persona-option">
                                    <input type="radio" name="personaType" value="energetic">
                                    <span class="persona-label">ğŸ¤ ç››ã‚Šä¸Šã’å‹</span>
                                    <span class="persona-desc">ãƒã‚¸ãƒ†ã‚£ãƒ–MCé¢¨ã«æ¥½ã—ã</span>
                                </label>
                                <label class="persona-option">
                                    <input type="radio" name="personaType" value="analytical">
                                    <span class="persona-label">ğŸ” æ·±æ˜ã‚Šå‹</span>
                                    <span class="persona-desc">å†·é™ã«åˆ†æãƒ»ä»®èª¬æ¤œè¨¼</span>
                                </label>
                                <label class="persona-option">
                                    <input type="radio" name="personaType" value="critical">
                                    <span class="persona-label">ğŸ“ ãƒã‚§ãƒƒã‚¯å‹</span>
                                    <span class="persona-desc">ã‚„ã‚„æ‰¹åˆ¤çš„ã«æ¤œè¨¼</span>
                                </label>
                                <label class="persona-option">
                                    <input type="radio" name="personaType" value="editor">
                                    <span class="persona-label">ğŸ“‹ è¦ç´„å‹</span>
                                    <span class="persona-desc">ã¾ã¨ã‚å½¹ãƒ»è¨€è³ªç¢ºèª</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>æ·±ã•ï¼ˆ1ãƒˆãƒ”ãƒƒã‚¯ã‚ãŸã‚Šã®è³ªå•å›æ•°ï¼‰</label>
                            <div class="radio-group">
                                <label><input type="radio" name="depth" value="standard" checked> æ¨™æº–</label>
                                <label><input type="radio" name="depth" value="deep"> é•·ã</label>
                            </div>
                        </div>
                    </div>

                    <!-- === ä¸­å¤®ã‚«ãƒ©ãƒ : éŸ³å£°ãƒ»èªè­˜è¨­å®š === -->
                    <div class="settings-col">
                        <div class="section-title">ğŸ”Š éŸ³å£°ãƒ»èªè­˜è¨­å®š</div>

                        <div class="form-group">
                            <label>éŸ³å£° (ãƒ–ãƒ©ã‚¦ã‚¶ä¾å­˜)</label>
                            <select id="voiceName">
                                <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>é€Ÿåº¦ (Rate): <span id="rateVal" class="range-val">1.3</span></label>
                            <div class="range-wrap">
                                <span>é…</span>
                                <input type="range" id="rate" min="0.5" max="2.0" step="0.1" value="1.3"
                                    oninput="document.getElementById('rateVal').innerText = this.value">
                                <span>é€Ÿ</span>
                            </div>
                            <button type="button" class="btn-preview" onclick="previewVoice()" style="margin-top:5px;">ğŸ”Š ãƒ†ã‚¹ãƒˆå†ç”Ÿ</button>
                        </div>

                        <div class="form-group">
                            <label>éŸ³å£°èªè­˜ã‚¨ãƒ³ã‚¸ãƒ³</label>
                            <div class="radio-group">
                                <label><input type="radio" name="sttMode" value="groq" checked> Groq Whisper (é«˜ç²¾åº¦)</label>
                                <label><input type="radio" name="sttMode" value="webspeech"> Web Speech API (ãƒ–ãƒ©ã‚¦ã‚¶å†…è”µ)</label>
                            </div>
                            <p class="help-text" id="stt-help">Groq Whisper: é«˜ç²¾åº¦ãªæ—¥æœ¬èªèªè­˜ã€‚<span style="color:#e67e22;">APIã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚’æ¶ˆè²»ã—ã¾ã™ã€‚</span></p>
                            <button type="button" class="btn-preview" onclick="testSTT()" id="stt-test-btn">ğŸ¤ ãƒ†ã‚¹ãƒˆéŒ²éŸ³</button>
                            <div id="stt-test-result" class="stt-test-result" style="display:none;"></div>
                        </div>
                    </div>

                    <!-- === å³ã‚«ãƒ©ãƒ : ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼å†…å®¹ === -->
                    <div class="settings-col">
                        <div class="section-title">ğŸ“ ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼å†…å®¹</div>

                        <div class="form-group">
                            <label>ã‚¿ã‚¤ãƒˆãƒ« <span style="color: #dc3545;">*</span></label>
                            <input type="text" id="title" placeholder="ã‚¢ãƒ—ãƒªé–‹ç™ºã«é–¢ã™ã‚‹ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼" oninput="validateTitle()">
                        </div>

                        <div class="form-group">
                            <label>
                                äº‹å‰çŸ¥è­˜ãƒ»å‚è€ƒè³‡æ–™
                                <span id="char-count" class="char-counter">0 / 3000</span>
                            </label>
                            <textarea id="preContext" style="height: 80px;"
                                placeholder="ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã®å‰æã¨ãªã‚‹çŸ¥è­˜ã€å‚è€ƒãƒ†ã‚­ã‚¹ãƒˆã€è‡ªèº«ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãªã©ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"
                                oninput="validateCharCount()"></textarea>
                        </div>

                        <div class="form-group" style="flex:1; display:flex; flex-direction:column;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                èããŸã„ã“ã¨ãƒªã‚¹ãƒˆ
                                <button type="button" class="btn-generate" onclick="generateTopics()" id="generateBtn">âœ¨ ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ç”Ÿæˆ</button>
                                <span id="generate-status" style="font-size: 0.75em; color: #666;"></span>
                            </label>
                            <textarea id="topics" style="flex:1; min-height:100px;" placeholder="1. è‡ªå·±ç´¹ä»‹
2. ã©ã‚“ãªã‚¢ãƒ—ãƒªã‚’é–‹ç™ºã—ã¦ã„ã¾ã™ã‹
3. è‚²æˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«å¿œå‹Ÿã—ã‚ˆã†ã¨æ€ã£ãŸãã£ã‹ã‘
4. è‚²æˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’çµŒé¨“ã—ã¦ã©ã†ã§ã—ãŸã‹ï¼Ÿ
5. ã‚¢ãƒ—ãƒªã®ä»Šå¾Œã¯ï¼Ÿ
6. æ¥å¹´åº¦å¿œå‹Ÿã™ã‚‹ã‚¯ãƒªã‚¨ãƒ¼ã‚¿ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"></textarea>
                        </div>

                        <button id="startBtn" class="btn" onclick="saveAndStart()" disabled>é–‹å§‹ã™ã‚‹</button>
                        <p id="start-help" class="help-text" style="text-align:center; color:#dc3545;">â€»APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                    </div>

                </div>
            </div>
        </div>

        <!-- ===== ä¸‹æ®µ: å±¥æ­´ (2ãƒšã‚¤ãƒ³) ===== -->
        <div class="bottom-pane">

            <!-- å·¦: å±¥æ­´ä¸€è¦§ -->
            <div class="col">
                <div class="col-header">ğŸ—‚ ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼å±¥æ­´</div>
                <div class="col-content">
                    <div id="history-list">
                        <div style="text-align:center; color:#999; margin-top:20px;">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
            </div>

            <!-- å³: å±¥æ­´è©³ç´° -->
            <div class="col">
                <div class="col-header" id="detail-header-bar">ğŸ“„ è©³ç´°</div>
                <div class="col-content">
                    <div id="history-detail">
                        <div class="detail-placeholder">
                            <div class="detail-placeholder-icon">ğŸ‘ˆ</div>
                            <div>å±¥æ­´ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <script>
        // AIäººæ ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®šç¾©
        const PERSONA_PROMPTS = {
            listener: `Act as an empathetic, highly skilled listener-interviewer focused on drawing out my honest feelings, values, and unspoken motives. Your goal is to make me feel safe enough to speak candidly while still clarifying my thinking.
Rules:
- You must reply in Japanese only.
- Ask exactly one open-ended question at a time.
- Always reflect my key words briefly (paraphrase in 1â€“2 sentences) before asking the next question.
- Build directly on my previous answer; do not change topics abruptly.
- Prioritize "why it matters to me," emotions, and decision-making context.
- When I seem vague, ask gently for a concrete example ("one specific episode, in time order").
Forbidden: judging me, giving advice too early, debating, or concluding on my behalf.
Close: When I say "ã¾ã¨ã‚ã¦" or when the interview seems complete, summarize my core points as (1) feelings, (2) values, (3) constraints, (4) what I truly want, and ask if the summary is accurate.`,

            energetic: `Act as an energetic, upbeat interviewer who hypes me up and draws out vivid stories, excitement, and memorable moments. Your goal is to increase momentum and help me talk more freely and concretely.
Rules:
- You must reply in Japanese only.
- Ask exactly one question at a time, preferably open-ended.
- React with positive energy in a short line, then ask the next question.
- Always build on my previous answer and dig for scenes, emotions, and details.
- Frequently ask for "the best moment," "the turning point," or "a specific scene you can replay."
- Encourage quick scales when helpful (e.g., "ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ã‚’10æ®µéšã§") but keep it light.
Forbidden: long lectures, strict cross-examination, negativity that shuts me down.
Close: After several turns, offer a punchy 3-bullet recap of highlights and ask which part to expand next.`,

            analytical: `Act as a calm, analytical interviewer who systematically digs into assumptions, causes, constraints, and evidence. Your goal is to transform my statements into clear, testable understanding.
Rules:
- You must reply in Japanese only.
- Ask exactly one question at a time.
- Always tie the next question to my previous answer.
- Push for precision: definitions, time order, actors, constraints, metrics, and counterexamples.
- Prefer questions that clarify: "what exactly," "under what conditions," "how do you know," "what would disprove it."
- If I give abstractions, request one concrete example and one measurable indicator.
Forbidden: emotional judgment, unnecessary hype, making up facts, concluding without evidence.
Close: When enough info is gathered, summarize as: (1) claim, (2) evidence, (3) assumptions, (4) risks/unknowns, (5) next verification step, and ask for confirmation.`,

            critical: `Act as a polite but critical interviewer (a "soft reviewer") who stress-tests my claims for weaknesses, inconsistencies, bias, and missing evidence. Your goal is constructive scrutiny, not personal attack.
Rules:
- You must reply in Japanese only.
- Ask exactly one question at a time.
- Always refer to my previous answer and probe its vulnerable point.
- Focus criticism on statements and evidence, never on me as a person.
- Frequently ask: alternative explanations, unfair comparisons, edge cases, and what might be wrong.
- If I sound overly confident, ask "what would change your mind" or "what would be a strong counterargument."
Forbidden: sarcasm, ridicule, ad hominem, endless nitpicking without purpose.
Close: After several turns, list the top 3 concerns as questions, then ask which one we should resolve first.`,

            editor: `Act as an editor-interviewer who structures messy conversation into a clear narrative and actionable decisions. Your goal is to produce an accurate, agreed-upon summary and next steps.
Rules:
- You must reply in Japanese only.
- Ask exactly one question at a time.
- After every 2â€“3 answers from me, provide a brief structured recap (no new information).
- Keep forcing clarity: prioritize, define terms, separate facts vs opinions, and confirm scope (what can be shared).
- Drive toward outputs: conclusion, key bullets, and next actions.
Forbidden: adding details I didn't say, exaggeration, changing meaning, pushing your own agenda.
Close: End with a final summary in this format: (1)è¦ç‚¹3ã¤, (2)å‰æ/åˆ¶ç´„, (3)æœªç¢ºå®šäº‹é …, (4)æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³, (5)å…¬é–‹å¯å¦/ç¯„å›², then ask "ã“ã®è¦ç´„ã§æ­£ã—ã„ã‹".`
        };

        const PERSONA_LABELS = {
            listener: 'ğŸ§ å‚¾è´å‹',
            energetic: 'ğŸ¤ ç››ã‚Šä¸Šã’å‹',
            analytical: 'ğŸ” æ·±æ˜ã‚Šå‹',
            critical: 'ğŸ“ ãƒã‚§ãƒƒã‚¯å‹',
            editor: 'ğŸ“‹ è¦ç´„å‹'
        };

        // ãƒ¢ãƒ‡ãƒ«ãƒªã‚¹ãƒˆï¼ˆæ®‹é‡ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
        const MODEL_IDS = [
            'llama-3.1-8b-instant',
            'openai/gpt-oss-20b',
            'meta-llama/llama-4-maverick-17b-128e-instruct',
            'meta-llama/llama-4-scout-17b-16e-instruct',
            'qwen/qwen3-32b',
            'llama-3.3-70b-versatile',
            'openai/gpt-oss-120b',
            'moonshotai/kimi-k2-instruct-0905'
        ];

        function getSelectedModel() {
            return document.querySelector('input[name="modelName"]:checked')?.value || 'llama-3.1-8b-instant';
        }

        function formatNum(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return Math.round(n / 1000) + 'K';
            return n.toLocaleString();
        }

        async function checkRateLimits() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                alert('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const btn = document.getElementById('checkLimitsBtn');
            const statusEl = document.getElementById('limits-status');
            btn.disabled = true;
            statusEl.innerText = 'ãƒã‚§ãƒƒã‚¯ä¸­...';

            MODEL_IDS.forEach((_, i) => {
                const el = document.getElementById(`limit-${i}`);
                if (el) el.innerHTML = 'â³';
            });

            const results = await Promise.allSettled(
                MODEL_IDS.map(async (modelId) => {
                    try {
                        const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: JSON.stringify({
                                model: modelId,
                                messages: [{ role: "user", content: "hi" }],
                                max_tokens: 1
                            })
                        });
                        return {
                            ok: res.ok,
                            status: res.status,
                            remainingRequests: res.headers.get('x-ratelimit-remaining-requests'),
                            limitRequests: res.headers.get('x-ratelimit-limit-requests'),
                            remainingTokens: res.headers.get('x-ratelimit-remaining-tokens'),
                            limitTokens: res.headers.get('x-ratelimit-limit-tokens'),
                        };
                    } catch (e) {
                        return { ok: false, status: 0, error: e.message };
                    }
                })
            );

            results.forEach((result, i) => {
                const el = document.getElementById(`limit-${i}`);
                if (!el) return;

                if (result.status === 'fulfilled' && result.value.ok) {
                    const r = result.value;
                    if (r.remainingRequests !== null) {
                        const remaining = parseInt(r.remainingRequests);
                        const limit = parseInt(r.limitRequests);
                        const pct = limit > 0 ? remaining / limit : 0;
                        const color = pct > 0.5 ? '#28a745' : pct > 0.1 ? '#e67e22' : '#dc3545';
                        el.innerHTML = `<span style="color:${color};font-weight:bold;">${formatNum(remaining)}</span><span style="color:#aaa;">/${formatNum(limit)}</span>`;
                    } else {
                        el.innerHTML = '<span style="color:#28a745;">âœ…</span>';
                    }
                } else if (result.status === 'fulfilled' && result.value.status === 429) {
                    el.innerHTML = '<span style="color:#dc3545;font-weight:bold;">åˆ¶é™ä¸­</span>';
                } else if (result.status === 'fulfilled') {
                    el.innerHTML = `<span style="color:#999;" title="HTTP ${result.value.status}">N/A</span>`;
                } else {
                    el.innerHTML = '<span style="color:#dc3545;">âŒ</span>';
                }
            });

            btn.disabled = false;
            statusEl.innerText = '';
        }

        // é¸æŠã•ã‚ŒãŸäººæ ¼ã‚¿ã‚¤ãƒ—ã‚’å–å¾—
        function getSelectedPersonaType() {
            return document.querySelector('input[name="personaType"]:checked')?.value || 'listener';
        }

        // é¸æŠã•ã‚ŒãŸäººæ ¼ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—
        function getSelectedPersonaPrompt() {
            return PERSONA_PROMPTS[getSelectedPersonaType()];
        }

        let isApiValid = false;
        let isCharValid = true;
        let isTitleValid = false;
        const MAX_CHARS = 3000;

        const DB_NAME = "InterviewDB";
        const DB_VERSION = 1;
        const STORE_NAME = "archives";

        // --- æ–‡å­—æ•°ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ ---
        function validateCharCount() {
            const text = document.getElementById('preContext').value;
            const count = text.length;
            const counterEl = document.getElementById('char-count');

            counterEl.innerText = `${count} / ${MAX_CHARS}`;

            if (count > MAX_CHARS) {
                counterEl.classList.add('char-over');
                isCharValid = false;
            } else {
                counterEl.classList.remove('char-over');
                isCharValid = true;
            }
            updateStartButton();
        }

        // --- ã‚¿ã‚¤ãƒˆãƒ«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ ---
        function validateTitle() {
            const title = document.getElementById('title').value.trim();
            isTitleValid = title.length > 0;
            updateStartButton();
        }

        // --- API Validation ---
        async function validateApi() {
            const key = document.getElementById('apiKey').value.trim();
            const statusEl = document.getElementById('api-status');

            if (!key) {
                statusEl.innerText = "";
                isApiValid = false;
                updateStartButton();
                return;
            }

            statusEl.className = "status-indicator status-loading";
            statusEl.innerText = "ç¢ºèªä¸­...";

            try {
                const res = await fetch("https://api.groq.com/openai/v1/models", {
                    headers: { "Authorization": `Bearer ${key}` }
                });

                if (res.ok) {
                    statusEl.className = "status-indicator status-ok";
                    statusEl.innerText = "âœ… æœ‰åŠ¹";
                    isApiValid = true;
                } else {
                    statusEl.className = "status-indicator status-err";
                    statusEl.innerText = "âŒ ç„¡åŠ¹";
                    isApiValid = false;
                }
            } catch (e) {
                statusEl.className = "status-indicator status-err";
                statusEl.innerText = "âŒ ã‚¨ãƒ©ãƒ¼";
                isApiValid = false;
            }
            updateStartButton();
        }

        function updateStartButton() {
            const btn = document.getElementById('startBtn');
            const help = document.getElementById('start-help');

            const ready = isApiValid && isTitleValid && isCharValid;

            btn.disabled = !ready;

            if (!isApiValid) {
                help.innerText = "â€»æœ‰åŠ¹ãªAPIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
                help.style.display = 'block';
            } else if (!isTitleValid) {
                help.innerText = "â€»ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
                help.style.display = 'block';
            } else if (!isCharValid) {
                help.innerText = "â€»äº‹å‰çŸ¥è­˜ã®æ–‡å­—æ•°ãŒä¸Šé™ã‚’è¶…ãˆã¦ã„ã¾ã™";
                help.style.display = 'block';
            } else {
                help.style.display = 'none';
            }
        }

        // --- ãƒˆãƒ”ãƒƒã‚¯è‡ªå‹•ç”Ÿæˆ ---
        async function generateTopics() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const title = document.getElementById('title').value.trim();
            const personaType = getSelectedPersonaType();
            const personaLabel = PERSONA_LABELS[personaType];
            const modelName = getSelectedModel();

            if (!apiKey) {
                alert('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            if (!title) {
                alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const btn = document.getElementById('generateBtn');
            const statusEl = document.getElementById('generate-status');

            btn.disabled = true;
            statusEl.innerText = 'ç”Ÿæˆä¸­...';

            const systemPrompt = `ã‚ãªãŸã¯å‰µé€ çš„ãªã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ä¼ç”»è€…ã§ã™ã€‚
ä¸ãˆã‚‰ã‚ŒãŸã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ã€èˆˆå‘³æ·±ã„è³ªå•ãƒˆãƒ”ãƒƒã‚¯ã‚’10å€‹ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼š${personaLabel}

ãƒ«ãƒ¼ãƒ«ï¼š
- åŸºæœ¬çš„ãªè³ªå•ã‹ã‚‰å§‹ã‚ã€å¾ã€…ã«æ·±ã„è³ªå•ã¸
- ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ç›´æ¥é€£æƒ³ã•ã‚Œã‚‹è³ªå•ã ã‘ã§ãªãã€å‰µé€ çš„ãƒ»æ„å¤–æ€§ã®ã‚ã‚‹è³ªå•ã‚‚å«ã‚ã‚‹
- ç›¸æ‰‹ã®çµŒé¨“ã€æ„Ÿæƒ…ã€è€ƒãˆã€å°†æ¥ã®å±•æœ›ãªã©å¤šè§’çš„ãªè¦–ç‚¹ã‹ã‚‰
- å„ãƒˆãƒ”ãƒƒã‚¯ã¯ç°¡æ½”ã«ï¼ˆ1è¡Œã§ï¼‰
- ç•ªå·ä»˜ããƒªã‚¹ãƒˆã§å‡ºåŠ›ï¼ˆ1. 2. 3. ...ï¼‰
- ä½™è¨ˆãªèª¬æ˜ã¯ä¸è¦ã€ãƒªã‚¹ãƒˆã®ã¿å‡ºåŠ›`;

            const userPrompt = `ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¿ã‚¤ãƒˆãƒ«ï¼šã€Œ${title}ã€\n\nã“ã®ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã§èãã¹ãè³ªå•ãƒˆãƒ”ãƒƒã‚¯ã‚’10å€‹ã€å‰µé€ çš„ã«ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚`;

            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: modelName,
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: userPrompt }
                        ],
                        temperature: 0.7,
                        max_tokens: 1024
                    })
                });

                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    throw new Error(err.error?.message || response.statusText);
                }

                const data = await response.json();
                const generatedText = data.choices[0].message.content;

                document.getElementById('topics').value = generatedText;
                statusEl.innerText = 'âœ… ç”Ÿæˆå®Œäº†';
                setTimeout(() => { statusEl.innerText = ''; }, 2000);

            } catch (e) {
                console.error('Generate Error:', e);
                statusEl.innerText = 'âŒ ã‚¨ãƒ©ãƒ¼';
                alert('ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
            } finally {
                btn.disabled = false;
            }
        }

        // --- è¨­å®šä¿å­˜ã¨é–‹å§‹ ---
        function saveAndStart() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) return alert("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            if (document.getElementById('saveApiKey').checked) {
                localStorage.setItem('groqApiKey', apiKey);
            } else {
                localStorage.removeItem('groqApiKey');
            }

            const config = {
                apiKey: apiKey,
                modelName: getSelectedModel(),
                title: document.getElementById('title').value,
                context: document.getElementById('preContext').value,
                topics: document.getElementById('topics').value.split('\n').filter(line => line.trim() !== ''),
                depth: document.querySelector('input[name="depth"]:checked').value,
                voiceName: document.getElementById('voiceName').value,
                rate: parseFloat(document.getElementById('rate').value),
                pitch: 1.0,
                volume: 1.0,
                personaType: getSelectedPersonaType(),
                persona: getSelectedPersonaPrompt(),
                sttMode: document.querySelector('input[name="sttMode"]:checked').value
            };

            localStorage.setItem('interviewConfig', JSON.stringify(config));
            window.location.href = 'interview_app.html';
        }

        // --- éŸ³å£°é–¢é€£ ---
        function populateVoiceList() {
            if (typeof speechSynthesis === 'undefined') return;
            const voices = speechSynthesis.getVoices();
            const voiceSelect = document.getElementById('voiceName');
            const jaVoices = voices.filter(v => v.lang.includes('ja') || v.lang.includes('JP'));
            voiceSelect.innerHTML = '';
            if (jaVoices.length === 0) {
                const option = document.createElement('option');
                option.text = "æ—¥æœ¬èªéŸ³å£°ãªã—";
                voiceSelect.add(option); return;
            }
            jaVoices.forEach((voice) => {
                const option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.value = voice.name;
                if (voice.name === 'Google æ—¥æœ¬èª') option.selected = true;
                voiceSelect.appendChild(option);
            });
        }
        populateVoiceList();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = populateVoiceList;
        }

        // ä¿å­˜ã•ã‚ŒãŸAPIã‚­ãƒ¼ã‚’èª­ã¿è¾¼ã‚€
        (function loadSavedApiKey() {
            const savedKey = localStorage.getItem('groqApiKey');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
                document.getElementById('saveApiKey').checked = true;
                validateApi();
            }
        })();

        // STTãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿æ™‚ã®ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
        document.querySelectorAll('input[name="sttMode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const help = document.getElementById('stt-help');
                if (this.value === 'groq') {
                    help.innerHTML = 'Groq Whisper: é«˜ç²¾åº¦ãªæ—¥æœ¬èªèªè­˜ã€‚<span style="color:#e67e22;">APIã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚’æ¶ˆè²»ã—ã¾ã™ã€‚</span>';
                } else {
                    help.innerHTML = 'Web Speech API: ãƒ–ãƒ©ã‚¦ã‚¶å†…è”µã®éŸ³å£°èªè­˜ã€‚ç„¡æ–™ã§ã™ãŒã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãŒå¿…è¦ã§ã™ï¼ˆChrome/Edgeï¼‰ã€‚';
                }
            });
        });

        // ä¿å­˜ã•ã‚ŒãŸSTTãƒ¢ãƒ¼ãƒ‰ã‚’å¾©å…ƒ
        (function loadSavedSttMode() {
            const saved = localStorage.getItem('interviewConfig');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    if (config.sttMode) {
                        const radio = document.querySelector(`input[name="sttMode"][value="${config.sttMode}"]`);
                        if (radio) {
                            radio.checked = true;
                            radio.dispatchEvent(new Event('change'));
                        }
                    }
                } catch(e) {}
            }
        })();

        function previewVoice() {
            const voiceName = document.getElementById('voiceName').value;
            const rate = parseFloat(document.getElementById('rate').value);
            if (!voiceName) return alert("éŸ³å£°ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“");
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance("ä»Šæ—¥ã¯ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼");
            utterance.rate = rate; utterance.volume = 1.0; utterance.pitch = 1.0;
            const voices = window.speechSynthesis.getVoices();
            const selectedVoice = voices.find(v => v.name === voiceName);
            if (selectedVoice) utterance.voice = selectedVoice;
            window.speechSynthesis.speak(utterance);
        }

        // --- STT ãƒ†ã‚¹ãƒˆéŒ²éŸ³ ---
        async function testSTT() {
            const sttMode = document.querySelector('input[name="sttMode"]:checked').value;
            const resultEl = document.getElementById('stt-test-result');
            const btn = document.getElementById('stt-test-btn');
            resultEl.style.display = 'block';

            if (sttMode === 'webspeech') {
                // Web Speech API ãƒ†ã‚¹ãƒˆ
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    resultEl.innerText = 'âŒ ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯Web Speech APIã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“';
                    return;
                }
                resultEl.innerText = 'ğŸ¤ è©±ã—ã¦ãã ã•ã„...';
                btn.disabled = true;

                const recognition = new SpeechRecognition();
                recognition.lang = 'ja-JP';
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onresult = (event) => {
                    const text = event.results[0][0].transcript;
                    const confidence = (event.results[0][0].confidence * 100).toFixed(0);
                    resultEl.innerText = `âœ… "${text}" (ä¿¡é ¼åº¦: ${confidence}%)`;
                    btn.disabled = false;
                };
                recognition.onerror = (event) => {
                    if (event.error === 'no-speech') {
                        resultEl.innerText = 'âš ï¸ éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ';
                    } else if (event.error === 'network') {
                        resultEl.innerText = 'âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã€‚Chrome/Edgeã§è©¦ã—ã¦ãã ã•ã„ã€‚';
                    } else {
                        resultEl.innerText = `âŒ ã‚¨ãƒ©ãƒ¼: ${event.error}`;
                    }
                    btn.disabled = false;
                };
                recognition.onend = () => {
                    if (resultEl.innerText.includes('è©±ã—ã¦ãã ã•ã„')) {
                        resultEl.innerText = 'âš ï¸ éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ';
                    }
                    btn.disabled = false;
                };
                recognition.start();
            } else {
                // Groq Whisper ãƒ†ã‚¹ãƒˆ
                const apiKey = document.getElementById('apiKey').value.trim();
                if (!apiKey) {
                    resultEl.innerText = 'âŒ APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                    return;
                }

                resultEl.innerText = 'ğŸ¤ éŒ²éŸ³ä¸­... (3ç§’é–“è©±ã—ã¦ãã ã•ã„)';
                btn.disabled = true;

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const mediaRecorder = new MediaRecorder(stream);
                    const chunks = [];

                    mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) chunks.push(e.data);
                    };

                    mediaRecorder.onstop = async () => {
                        stream.getTracks().forEach(t => t.stop());
                        const blob = new Blob(chunks, { type: mediaRecorder.mimeType });
                        resultEl.innerText = 'ğŸ”„ æ–‡å­—èµ·ã“ã—ä¸­...';

                        try {
                            const ext = blob.type.includes('mp4') ? 'mp4' : blob.type.includes('ogg') ? 'ogg' : 'webm';
                            const formData = new FormData();
                            formData.append('file', blob, `test.${ext}`);
                            formData.append('model', 'whisper-large-v3-turbo');
                            formData.append('language', 'ja');
                            formData.append('response_format', 'json');

                            const controller = new AbortController();
                            setTimeout(() => controller.abort(), 15000);

                            const res = await fetch('https://api.groq.com/openai/v1/audio/transcriptions', {
                                method: 'POST',
                                headers: { 'Authorization': `Bearer ${apiKey}` },
                                body: formData,
                                signal: controller.signal
                            });

                            if (!res.ok) throw new Error(`API Error: ${res.status}`);
                            const data = await res.json();
                            const text = data.text?.trim();
                            if (text) {
                                resultEl.innerText = `âœ… "${text}"`;
                            } else {
                                resultEl.innerText = 'âš ï¸ éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ';
                            }
                        } catch (e) {
                            resultEl.innerText = `âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}`;
                        }
                        btn.disabled = false;
                    };

                    mediaRecorder.start();
                    setTimeout(() => {
                        if (mediaRecorder.state === 'recording') {
                            mediaRecorder.stop();
                        }
                    }, 3000);
                } catch (e) {
                    resultEl.innerText = `âŒ ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: ${e.message}`;
                    btn.disabled = false;
                }
            }
        }

        // --- DB & å±¥æ­´è¡¨ç¤º ---
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: "id" });
                };
                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        async function loadHistory() {
            const listEl = document.getElementById('history-list');

            try {
                const db = await openDB();
                const tx = db.transaction(STORE_NAME, "readonly");
                const store = tx.objectStore(STORE_NAME);
                const request = store.getAll();

                request.onsuccess = () => {
                    const records = request.result;
                    records.sort((a, b) => b.id - a.id);

                    if (records.length === 0) {
                        listEl.innerHTML = `
                        <div class="history-empty">
                            <div class="history-empty-icon">ğŸ“­</div>
                            <div>ã¾ã ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>
                            <div style="font-size: 0.85em; margin-top: 5px;">ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚’å®Œäº†ã™ã‚‹ã¨ã€ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
                        </div>`;
                        return;
                    }

                    listEl.innerHTML = `<div style="font-size: 0.8em; color: #666; margin-bottom: 8px;">${records.length}ä»¶ã®å±¥æ­´</div>`;
                    records.forEach(rec => {
                        const item = document.createElement('div');
                        item.className = 'history-item';
                        item.innerHTML = `<div class="history-date">${rec.date}</div><div class="history-title">${rec.title}</div>`;
                        item.onclick = () => {
                            document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active'));
                            item.classList.add('active');
                            showDetail(rec);
                        };
                        listEl.appendChild(item);
                    });
                };
            } catch (e) {
                console.error(e);
                listEl.innerHTML = "DBã‚¨ãƒ©ãƒ¼";
            }
        }

        // ç¾åœ¨é¸æŠä¸­ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä¿æŒ
        let selectedRecord = null;

        function showDetail(rec) {
            selectedRecord = rec;
            const detailEl = document.getElementById('history-detail');
            const headerBar = document.getElementById('detail-header-bar');
            headerBar.innerText = `ğŸ“„ ${rec.title}`;

            // AIã®ç™ºè¨€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿½è·¡
            let aiResponseIndex = 0;

            const chatHtml = rec.history.map((h, idx) => {
                const role = h.role === 'assistant' ? 'ğŸ¤– AI' : (h.role === 'user' ? 'ğŸ‘¤ User' : h.role);
                const roleClass = h.role === 'assistant' ? 'chat-ai' : 'chat-user';
                const text = h.content;

                let promptBtn = '';
                if (h.role === 'assistant' && rec.promptLog && rec.promptLog.length > 0) {
                    const logEntry = rec.promptLog.find(log => log.aiResponseIndex === aiResponseIndex);
                    if (logEntry) {
                        const logIndex = rec.promptLog.indexOf(logEntry);
                        promptBtn = `<button class="btn-show-prompt" onclick="showPromptDetail(${logIndex})">ğŸ› ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</button>`;
                    }
                    aiResponseIndex++;
                }

                return `<div class="chat-row ${roleClass}"><div class="chat-role">${role}${promptBtn}</div><div>${text}</div></div>`;
            }).join('');

            // è¨­å®šæƒ…å ±ã®HTML
            let settingsHtml = '';
            if (rec.settings) {
                const s = rec.settings;
                const topicsText = rec.topics && rec.topics.length > 0 ? rec.topics.join(' / ') : 'ä¸æ˜';
                const topicsDisplay = topicsText.length > 150 ? topicsText.substring(0, 150) + '...' : topicsText;
                settingsHtml = `
                <div class="detail-section-title">ä½¿ç”¨è¨­å®š</div>
                <div class="settings-info">
                    <div class="setting-row"><span class="setting-label">ãƒ¢ãƒ‡ãƒ«:</span> ${s.modelName || 'ä¸æ˜'}</div>
                    <div class="setting-row"><span class="setting-label">æ·±ã•:</span> ${s.depth === 'deep' ? 'é•·ã' : 'æ¨™æº–'}</div>
                    <div class="setting-row"><span class="setting-label">éŸ³å£°:</span> ${s.voiceName || 'ä¸æ˜'}</div>
                    <div class="setting-row"><span class="setting-label">é€Ÿåº¦:</span> ${s.rate || 'ä¸æ˜'}</div>
                    <div class="setting-row"><span class="setting-label">ãƒˆãƒ”ãƒƒã‚¯:</span><div class="setting-text">${topicsDisplay}</div></div>
                    ${s.context ? `<div class="setting-row"><span class="setting-label">äº‹å‰çŸ¥è­˜:</span><div class="setting-text">${s.context.substring(0, 200)}${s.context.length > 200 ? '...' : ''}</div></div>` : ''}
                    <div class="setting-row"><span class="setting-label">æ€§æ ¼:</span> ${s.personaType ? (PERSONA_LABELS[s.personaType] || s.personaType) : 'ä¸æ˜'}</div>
                </div>
                <button onclick="applySettings()" class="btn-apply-settings">ğŸ”„ ã“ã®è¨­å®šã‚’ã‚»ãƒƒãƒˆ</button>
            `;
            }

            detailEl.innerHTML = `
            <div class="detail-header">
                <div class="detail-title">${rec.title}</div>
                <div class="detail-meta">æ—¥æ™‚: ${rec.date}</div>
                <button onclick="deleteRecord(${rec.id})" class="btn-delete">ğŸ—‘ ã“ã®å±¥æ­´ã‚’å‰Šé™¤</button>
            </div>
            ${settingsHtml}
            <div class="detail-section-title">ã‚µãƒãƒªãƒ¼</div>
            <div class="detail-summary">${rec.summary}</div>
            <button onclick="navigator.clipboard.writeText(\`${rec.summary.replace(/`/g, '\\`')}\`)" style="margin-top:5px; padding:5px; font-size:0.8em; cursor:pointer;">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
            <div class="detail-section-title">ä¼šè©±ãƒ­ã‚° (${rec.history.length}ã‚¿ãƒ¼ãƒ³)</div>
            <div class="detail-chat">${chatHtml}</div>
        `;
        }

        async function deleteRecord(id) {
            if (!confirm('ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nå‰Šé™¤ã™ã‚‹ã¨å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                return;
            }
            try {
                const db = await openDB();
                const tx = db.transaction(STORE_NAME, "readwrite");
                const store = tx.objectStore(STORE_NAME);
                store.delete(id);
                tx.oncomplete = () => {
                    selectedRecord = null;
                    // è©³ç´°ã‚’ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã«æˆ»ã™
                    const detailEl = document.getElementById('history-detail');
                    const headerBar = document.getElementById('detail-header-bar');
                    headerBar.innerText = 'ğŸ“„ è©³ç´°';
                    detailEl.innerHTML = `
                        <div class="detail-placeholder">
                            <div class="detail-placeholder-icon">ğŸ‘ˆ</div>
                            <div>å±¥æ­´ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                        </div>`;
                    loadHistory();
                    alert('å‰Šé™¤ã—ã¾ã—ãŸ');
                };
            } catch (e) {
                console.error("Delete Error:", e);
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        function applySettings() {
            if (!selectedRecord || !selectedRecord.settings) {
                alert('ã“ã®å±¥æ­´ã«ã¯è¨­å®šæƒ…å ±ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            const s = selectedRecord.settings;
            const rec = selectedRecord;

            // ãƒ•ã‚©ãƒ¼ãƒ ã«è¨­å®šã‚’åæ˜ 
            document.getElementById('title').value = rec.title || '';
            document.getElementById('preContext').value = s.context || '';
            document.getElementById('topics').value = rec.topics ? rec.topics.join('\n') : '';

            // AIäººæ ¼é¸æŠ
            if (s.personaType) {
                const personaRadio = document.querySelector(`input[name="personaType"][value="${s.personaType}"]`);
                if (personaRadio) personaRadio.checked = true;
            }

            // ãƒ¢ãƒ‡ãƒ«é¸æŠ
            if (s.modelName) {
                const modelRadio = document.querySelector(`input[name="modelName"][value="${s.modelName}"]`);
                if (modelRadio) modelRadio.checked = true;
            }

            // æ·±ã•
            if (s.depth) {
                const depthRadio = document.querySelector(`input[name="depth"][value="${s.depth}"]`);
                if (depthRadio) depthRadio.checked = true;
            }

            // éŸ³å£°ï¼ˆãƒªã‚¹ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
            const voiceSelect = document.getElementById('voiceName');
            if (s.voiceName) {
                for (let opt of voiceSelect.options) {
                    if (opt.value === s.voiceName) {
                        opt.selected = true;
                        break;
                    }
                }
            }

            // é€Ÿåº¦
            if (s.rate) {
                document.getElementById('rate').value = s.rate;
                document.getElementById('rateVal').innerText = s.rate;
            }

            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
            validateCharCount();
            validateTitle();

            alert('è¨­å®šã‚’ã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼');
        }

        loadHistory();

        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
        function showPromptDetail(logIndex) {
            if (!selectedRecord || !selectedRecord.promptLog || !selectedRecord.promptLog[logIndex]) {
                alert('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            const log = selectedRecord.promptLog[logIndex];
            const modal = document.getElementById('prompt-modal');
            const body = document.getElementById('prompt-modal-body');

            const messagesHtml = log.messages
                .filter(m => m.role !== 'system')
                .map(m => `<div style="margin-bottom: 5px;"><strong style="color: ${m.role === 'user' ? '#ff6b6b' : '#98fb98'};">${m.role}:</strong> ${escapeHtml(m.content.substring(0, 200))}${m.content.length > 200 ? '...' : ''}</div>`)
                .join('');

            body.innerHTML = `
                <div class="prompt-section">
                    <div class="prompt-section-title">ğŸ“… ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—: ${log.timestamp}</div>
                </div>
                <div class="prompt-section">
                    <div class="prompt-section-title">ğŸ“¡ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${log.status}</div>
                </div>
                <div class="prompt-section">
                    <div class="prompt-section-title">ğŸ“œ System Prompt:</div>
                    <div class="prompt-content">${escapeHtml(log.systemPrompt)}</div>
                </div>
                <div class="prompt-section">
                    <div class="prompt-section-title">ğŸ’¬ é€ä¿¡ã—ãŸä¼šè©±å±¥æ­´ (${log.messages.filter(m => m.role !== 'system').length}ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸):</div>
                    <div class="prompt-content prompt-messages">${messagesHtml || '(ãªã—)'}</div>
                </div>
                ${log.response ? `
                <div class="prompt-section">
                    <div class="prompt-section-title">ğŸ¤– AIã®å¿œç­”:</div>
                    <div class="prompt-content response">${escapeHtml(log.response)}</div>
                </div>
                ` : ''}
            `;

            modal.classList.add('active');
        }

        function closePromptModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('prompt-modal').classList.remove('active');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closePromptModal();
            }
        });
    </script>

</body>

</html>
