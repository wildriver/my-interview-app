<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Interview Setup (Groq)</title>
    <style>
        /* „É¨„Ç§„Ç¢„Ç¶„Éà */
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
            height: 100vh;
            overflow: hidden;
        }

        .layout-container {
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 15px;
            padding: 15px;
            height: 100vh;
            box-sizing: border-box;
        }

        .col {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .col-header {
            padding: 12px 20px;
            border-bottom: 1px solid #eee;
            background: #fafafa;
            font-weight: bold;
            color: #2c3e50;
            flex-shrink: 0;
            font-size: 0.95em;
        }

        .col-content {
            padding: 15px;
            overflow-y: auto;
            flex-grow: 1;
        }

        /* Settings 3-column grid */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1.2fr 1.3fr;
            gap: 20px;
        }

        .settings-col {
            display: flex;
            flex-direction: column;
        }

        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 4px;
            font-size: 0.85em;
            color: #34495e;
        }

        .help-text {
            font-size: 0.75em;
            color: #7f8c8d;
            margin-top: 2px;
            margin-bottom: 5px;
        }

        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 6px;
            font-size: 13px;
            box-sizing: border-box;
        }

        textarea {
            resize: vertical;
        }

        /* ÊñáÂ≠óÊï∞„Ç´„Ç¶„É≥„ÉàÁî® */
        .char-counter {
            float: right;
            font-weight: normal;
            font-size: 0.85em;
            color: #666;
        }

        .char-over {
            color: #dc3545;
            font-weight: bold;
        }

        .range-wrap {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
        }

        input[type="range"] {
            flex: 1;
            cursor: pointer;
        }

        .range-val {
            width: 30px;
            text-align: right;
            font-weight: bold;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: #f55036;
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 15px;
        }

        .btn:hover {
            background-color: #d43f29;
        }

        .btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        .btn-preview {
            display: inline-block;
            padding: 6px 12px;
            background-color: #e9ecef;
            color: #333;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 0.8em;
            cursor: pointer;
            text-align: center;
        }

        .btn-preview:hover {
            background-color: #dde2e6;
        }

        .radio-group label {
            display: inline-block;
            margin-right: 8px;
            font-weight: normal;
            cursor: pointer;
            font-size: 0.85em;
        }

        .status-indicator {
            font-size: 0.8em;
            margin-left: 5px;
        }

        .status-ok {
            color: #28a745;
        }

        .status-err {
            color: #dc3545;
        }

        .status-loading {
            color: #e67e22;
        }

        /* Bottom pane: history list + detail */
        .bottom-pane {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 15px;
            min-height: 0;
        }

        /* Â±•Ê≠¥„ÉªË©≥Á¥∞ */
        .history-empty {
            text-align: center;
            color: #999;
            padding: 30px 15px;
        }

        .history-empty-icon {
            font-size: 2.5em;
            margin-bottom: 8px;
        }

        .history-item {
            padding: 10px 12px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-item:hover {
            background-color: #f0f8ff;
            border-color: #007bff;
        }

        .history-item.active {
            background-color: #fff0ee;
            border-color: #f55036;
        }

        .history-date {
            font-size: 0.7em;
            color: #888;
            margin-bottom: 2px;
        }

        .history-title {
            font-weight: bold;
            font-size: 0.85em;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Ë©≥Á¥∞Ë°®Á§∫„Ç®„É™„Ç¢ */
        .detail-placeholder {
            text-align: center;
            color: #999;
            margin-top: 60px;
            font-size: 0.9em;
        }

        .detail-placeholder-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .detail-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .detail-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #f55036;
        }

        .detail-meta {
            font-size: 0.8em;
            color: #666;
            margin-top: 3px;
        }

        .detail-section-title {
            font-weight: bold;
            margin: 15px 0 8px 0;
            color: #444;
            border-left: 4px solid #28a745;
            padding-left: 8px;
            font-size: 0.9em;
        }

        .detail-summary {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 8px;
            line-height: 1.6;
            white-space: pre-wrap;
            font-size: 0.9em;
        }

        .detail-chat {
            font-size: 0.85em;
        }

        .chat-row {
            margin-bottom: 6px;
            padding: 6px 8px;
            border-radius: 6px;
        }

        .chat-role {
            font-weight: bold;
            font-size: 0.75em;
            margin-bottom: 2px;
        }

        .chat-user {
            background-color: #e3f2fd;
        }

        .chat-ai {
            background-color: #fff0ee;
        }

        /* Ë®≠ÂÆöÊÉÖÂ†±Ë°®Á§∫ */
        .settings-info {
            background: #f0f7ff;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.85em;
            margin-bottom: 8px;
        }

        .setting-row {
            margin-bottom: 4px;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .setting-label {
            font-weight: bold;
            color: #555;
            min-width: 60px;
            font-size: 0.9em;
        }

        .setting-text {
            background: #fff;
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 0.85em;
            color: #666;
            margin-top: 2px;
            width: 100%;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .btn-apply-settings {
            background: #007bff;
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .btn-apply-settings:hover {
            background: #0056b3;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75em;
            margin-top: 5px;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .btn-generate {
            background: #6f42c1;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7em;
        }

        .btn-generate:hover {
            background: #5a32a3;
        }

        .btn-generate:disabled {
            background: #aaa;
            cursor: not-allowed;
        }

        /* „Çª„ÇØ„Ç∑„Éß„É≥„Çø„Ç§„Éà„É´ */
        .section-title {
            font-weight: bold;
            font-size: 0.9em;
            color: #333;
            margin: 0 0 10px 0;
            padding: 6px 8px;
            background: #f0f0f0;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }

        /* AI‰∫∫Ê†ºÈÅ∏Êäû */
        .persona-options {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: 4px;
        }

        .persona-option {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .persona-option:hover {
            background: #f5f5f5;
        }

        .persona-option:has(input:checked) {
            background: #e8f4fd;
            border-color: #007bff;
        }

        .persona-option input {
            margin: 0;
        }

        .persona-label {
            font-weight: bold;
            font-size: 0.8em;
            min-width: 80px;
        }

        .persona-desc {
            font-size: 0.75em;
            color: #666;
        }

        /* „É¢„Éá„É´ÈÅ∏Êäû„ÉÜ„Éº„Éñ„É´ */
        .model-options {
            display: flex;
            flex-direction: column;
            gap: 3px;
            margin-top: 4px;
            max-height: 280px;
            overflow-y: auto;
        }

        .model-option {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border: 1px solid #eee;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .model-option:hover {
            background: #f5f5f5;
        }

        .model-option:has(input:checked) {
            background: #e8f4fd;
            border-color: #007bff;
        }

        .model-option input {
            margin: 0;
        }

        .model-name {
            flex: 1;
            font-weight: bold;
            font-size: 0.8em;
        }

        .model-tag {
            font-size: 0.65em;
            color: #fff;
            padding: 1px 5px;
            border-radius: 8px;
            white-space: nowrap;
        }

        .tag-fast { background: #28a745; }
        .tag-mid { background: #17a2b8; }
        .tag-quality { background: #6f42c1; }

        .model-limit {
            font-size: 0.75em;
            color: #888;
            min-width: 70px;
            text-align: right;
        }

        /* „Éó„É≠„É≥„Éó„ÉàË°®Á§∫„Éú„Çø„É≥ */
        .btn-show-prompt {
            background: #6c757d;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7em;
            margin-left: 8px;
        }

        .btn-show-prompt:hover {
            background: #5a6268;
        }

        /* „Éó„É≠„É≥„Éó„ÉàË°®Á§∫„É¢„Éº„ÉÄ„É´ */
        .prompt-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .prompt-modal.active {
            display: flex;
        }

        .prompt-modal-content {
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 0.85em;
            padding: 20px;
            border-radius: 12px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            width: 90%;
        }

        .prompt-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        .prompt-modal-title {
            color: #ffd700;
            font-weight: bold;
        }

        .prompt-modal-close {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .prompt-section {
            margin-bottom: 15px;
        }

        .prompt-section-title {
            color: #aaa;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .prompt-content {
            background: #2a2a2a;
            padding: 10px;
            border-radius: 6px;
            white-space: pre-wrap;
            word-break: break-word;
            color: #7fdbff;
            max-height: 200px;
            overflow-y: auto;
        }

        .prompt-content.response {
            color: #98fb98;
        }

        .prompt-messages {
            color: #ff6b6b;
        }

        /* STT test result */
        .stt-test-result {
            font-size: 0.8em;
            padding: 6px 10px;
            border-radius: 6px;
            margin-top: 5px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }

        /* Language selector */
        .lang-selector {
            display: inline-flex;
            gap: 4px;
            float: right;
        }
        .lang-btn {
            padding: 3px 10px;
            border: 1px solid #ddd;
            border-radius: 12px;
            background: #fff;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s;
        }
        .lang-btn:hover { background: #f0f0f0; }
        .lang-btn.active {
            background: #f55036;
            color: white;
            border-color: #f55036;
        }

        @media (max-width: 1100px) {
            .layout-container {
                grid-template-rows: auto;
                height: auto;
                overflow: auto;
            }

            body {
                height: auto;
                overflow: auto;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }

            .bottom-pane {
                grid-template-columns: 1fr;
            }

            .col {
                min-height: 400px;
            }
        }
    </style>
    <!-- OGPÂü∫Êú¨Ë®≠ÂÆö -->
    <meta property="og:title" content="AI Interviewer">
    <meta property="og:description" content="AI„Å´„Çà„ÇãÈü≥Â£∞„Ç§„É≥„Çø„Éì„É•„Éº„Ç¢„Éó„É™">
    <meta property="og:image" content="https://github.com/wildriver/my-interview-app/blob/main/ogp.png">
    <meta property="og:url" content="https://github.com/wildriver/my-interview-app/">
    <meta property="og:type" content="website">

    <!-- TwitterÁî®Ôºà‰ªªÊÑèÔºâ -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://github.com/wildriver/my-interview-app/blob/main/ogp.png">
</head>

<body>

    <!-- „Éó„É≠„É≥„Éó„ÉàË°®Á§∫„É¢„Éº„ÉÄ„É´ -->
    <div id="prompt-modal" class="prompt-modal" onclick="closePromptModal(event)">
        <div class="prompt-modal-content" onclick="event.stopPropagation()">
            <div class="prompt-modal-header">
                <span class="prompt-modal-title" data-i18n="prompt_modal_title">üêõ „Éó„É≠„É≥„Éó„ÉàË©≥Á¥∞</span>
                <button class="prompt-modal-close" onclick="closePromptModal()" data-i18n="btn_close">Èñâ„Åò„Çã</button>
            </div>
            <div id="prompt-modal-body"></div>
        </div>
    </div>

    <div class="layout-container">

        <!-- ===== ‰∏äÊÆµ: Ë®≠ÂÆö (3„Ç´„É©„É†) ===== -->
        <div class="col">
            <div class="col-header">
                <span data-i18n="settings_header">üõ† „Ç§„É≥„Çø„Éì„É•„ÉºË®≠ÂÆö</span>
                <div class="lang-selector" id="lang-selector"></div>
            </div>
            <div class="col-content">
                <div class="settings-grid">

                    <!-- === Â∑¶„Ç´„É©„É†: AI„ÅÆË®≠ÂÆö === -->
                    <div class="settings-col">
                        <div class="section-title" data-i18n="section_api">üîë API„Éª„É¢„Éá„É´Ë®≠ÂÆö</div>

                        <div class="form-group">
                            <label>
                                Groq API Key
                                <a href="https://console.groq.com/keys" target="_blank"
                                    style="font-size: 0.85em; margin-left: 8px;">[ÂèñÂæó]</a>
                                <span id="api-status" class="status-indicator"></span>
                            </label>
                            <input type="text" id="apiKey" placeholder="gsk_..." onblur="validateApi()">
                            <label style="font-size: 0.8em; margin-top: 4px; display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="saveApiKey"> „Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„Å´‰øùÂ≠ò„Åô„Çã
                            </label>
                        </div>

                        <div class="form-group">
                            <label>AI„ÅÆ„É¢„Éá„É´
                                <button type="button" class="btn-generate" onclick="checkRateLimits()" id="checkLimitsBtn">üîÑ ÊÆãÈáè„ÉÅ„Çß„ÉÉ„ÇØ</button>
                                <span id="limits-status" style="font-size: 0.75em; color: #666;"></span>
                            </label>
                            <div class="model-options">
                                <label class="model-option">
                                    <input type="radio" name="modelName" value="llama-3.1-8b-instant" checked>
                                    <span class="model-name">Llama 3.1 8B Instant</span>
                                    <span class="model-tag tag-fast" data-i18n="tag_fastest">ÊúÄÈÄü</span>
                                    <span class="model-limit" id="limit-0"></span>
                                </label>
                                <label class="model-option">
                                    <input type="radio" name="modelName" value="openai/gpt-oss-20b">
                                    <span class="model-name">GPT-OSS 20B</span>
                                    <span class="model-tag tag-mid" data-i18n="tag_fast">È´òÈÄü</span>
                                    <span class="model-limit" id="limit-1"></span>
                                </label>
                                <label class="model-option">
                                    <input type="radio" name="modelName" value="meta-llama/llama-4-maverick-17b-128e-instruct">
                                    <span class="model-name">Llama 4 Maverick 17B</span>
                                    <span class="model-tag tag-mid" data-i18n="tag_fast">È´òÈÄü</span>
                                    <span class="model-limit" id="limit-2"></span>
                                </label>
                                <label class="model-option">
                                    <input type="radio" name="modelName" value="meta-llama/llama-4-scout-17b-16e-instruct">
                                    <span class="model-name">Llama 4 Scout 17B</span>
                                    <span class="model-limit" id="limit-3"></span>
                                </label>
                                <label class="model-option">
                                    <input type="radio" name="modelName" value="qwen/qwen3-32b">
                                    <span class="model-name">Qwen3 32B</span>
                                    <span class="model-limit" id="limit-4"></span>
                                </label>
                                <label class="model-option">
                                    <input type="radio" name="modelName" value="llama-3.3-70b-versatile">
                                    <span class="model-name">Llama 3.3 70B</span>
                                    <span class="model-tag tag-quality" data-i18n="tag_quality">È´òÂìÅË≥™</span>
                                    <span class="model-limit" id="limit-5"></span>
                                </label>
                                <label class="model-option">
                                    <input type="radio" name="modelName" value="openai/gpt-oss-120b">
                                    <span class="model-name">GPT-OSS 120B</span>
                                    <span class="model-tag tag-quality" data-i18n="tag_quality">È´òÂìÅË≥™</span>
                                    <span class="model-limit" id="limit-6"></span>
                                </label>
                                <label class="model-option">
                                    <input type="radio" name="modelName" value="moonshotai/kimi-k2-instruct-0905">
                                    <span class="model-name">Kimi K2 Instruct</span>
                                    <span class="model-limit" id="limit-7"></span>
                                </label>
                            </div>
                            <p class="help-text">Â§ß„Åç„Å™„É¢„Éá„É´„Åª„Å©ÁÑ°ÊñôAPIÊû†„ÅåÂ∞ë„Å™„ÅÑ„ÄÇÊÆãÈáè„ÉÅ„Çß„ÉÉ„ÇØ„ÅØÂêÑ„É¢„Éá„É´„Å´1„É™„ÇØ„Ç®„Çπ„ÉàÊ∂àË≤ª„Åó„Åæ„Åô„ÄÇ</p>
                        </div>
                    </div>

                    <!-- === ‰∏≠Â§Æ„Ç´„É©„É†: AI„Ç§„É≥„Çø„Éì„É•„Éº„Ç¢Ë®≠ÂÆö === -->
                    <div class="settings-col">
                        <div class="section-title" data-i18n="section_interviewer">üéô AI„Ç§„É≥„Çø„Éì„É•„Éº„Ç¢Ë®≠ÂÆö</div>

                        <div class="form-group">
                            <label data-i18n="label_persona">„Ç§„É≥„Çø„Éì„É•„ÉºAI„ÅÆÊÄßÊ†º</label>
                            <div class="persona-options">
                                <label class="persona-option">
                                    <input type="radio" name="personaType" value="listener" checked>
                                    <span class="persona-label" data-i18n="persona_listener_label">üéß ÂÇæËÅ¥Âûã</span>
                                    <span class="persona-desc" data-i18n="persona_listener_desc">Êú¨Èü≥„ÇíÂºï„ÅçÂá∫„Åô„Ç´„Ç¶„É≥„Çª„É©„ÉºÈ¢®</span>
                                </label>
                                <label class="persona-option">
                                    <input type="radio" name="personaType" value="energetic">
                                    <span class="persona-label" data-i18n="persona_energetic_label">üé§ Áõõ„Çä‰∏ä„ÅíÂûã</span>
                                    <span class="persona-desc" data-i18n="persona_energetic_desc">„Éù„Ç∏„ÉÜ„Ç£„ÉñMCÈ¢®„Å´Ê•Ω„Åó„Åè</span>
                                </label>
                                <label class="persona-option">
                                    <input type="radio" name="personaType" value="analytical">
                                    <span class="persona-label" data-i18n="persona_analytical_label">üîç Ê∑±Êéò„ÇäÂûã</span>
                                    <span class="persona-desc" data-i18n="persona_analytical_desc">ÂÜ∑Èùô„Å´ÂàÜÊûê„Éª‰ªÆË™¨Ê§úË®º</span>
                                </label>
                                <label class="persona-option">
                                    <input type="radio" name="personaType" value="critical">
                                    <span class="persona-label" data-i18n="persona_critical_label">üìù „ÉÅ„Çß„ÉÉ„ÇØÂûã</span>
                                    <span class="persona-desc" data-i18n="persona_critical_desc">„ÇÑ„ÇÑÊâπÂà§ÁöÑ„Å´Ê§úË®º</span>
                                </label>
                                <label class="persona-option">
                                    <input type="radio" name="personaType" value="editor">
                                    <span class="persona-label" data-i18n="persona_editor_label">üìã Ë¶ÅÁ¥ÑÂûã</span>
                                    <span class="persona-desc" data-i18n="persona_editor_desc">„Åæ„Å®„ÇÅÂΩπ„ÉªË®ÄË≥™Á¢∫Ë™ç</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label data-i18n="label_depth">Ê∑±„ÅïÔºà1„Éà„Éî„ÉÉ„ÇØ„ÅÇ„Åü„Çä„ÅÆË≥™ÂïèÂõûÊï∞Ôºâ</label>
                            <div class="radio-group">
                                <label><input type="radio" name="depth" value="standard" checked> <span data-i18n="depth_standard">Ê®ôÊ∫ñ</span></label>
                                <label><input type="radio" name="depth" value="deep"> <span data-i18n="depth_deep">Èï∑„Åè</span></label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label data-i18n="label_voice">Èü≥Â£∞ („Éñ„É©„Ç¶„Ç∂‰æùÂ≠ò)</label>
                            <select id="voiceName">
                                <option value="">Ë™≠„ÅøËæº„Åø‰∏≠...</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>ÈÄüÂ∫¶ (Rate): <span id="rateVal" class="range-val">1.3</span></label>
                            <div class="range-wrap">
                                <span>ÈÅÖ</span>
                                <input type="range" id="rate" min="0.5" max="2.0" step="0.1" value="1.3"
                                    oninput="document.getElementById('rateVal').innerText = this.value">
                                <span>ÈÄü</span>
                            </div>
                            <button type="button" class="btn-preview" onclick="previewVoice()" style="margin-top:5px;" data-i18n="btn_test_voice">üîä „ÉÜ„Çπ„ÉàÂÜçÁîü</button>
                        </div>

                        <div class="form-group">
                            <label data-i18n="label_stt">Èü≥Â£∞Ë™çË≠ò„Ç®„É≥„Ç∏„É≥</label>
                            <div class="radio-group">
                                <label><input type="radio" name="sttMode" value="groq" checked> <span data-i18n="stt_groq">Groq Whisper (È´òÁ≤æÂ∫¶)</span></label>
                                <label><input type="radio" name="sttMode" value="webspeech"> <span data-i18n="stt_webspeech">Web Speech API („Éñ„É©„Ç¶„Ç∂ÂÜÖËîµ)</span></label>
                            </div>
                            <p class="help-text" id="stt-help">Groq Whisper: È´òÁ≤æÂ∫¶„Å™Êó•Êú¨Ë™ûË™çË≠ò„ÄÇ<span style="color:#e67e22;">API„ÇØ„É¨„Ç∏„ÉÉ„Éà„ÇíÊ∂àË≤ª„Åó„Åæ„Åô„ÄÇ</span></p>
                            <button type="button" class="btn-preview" onclick="testSTT()" id="stt-test-btn" data-i18n="btn_test_stt">üé§ „ÉÜ„Çπ„ÉàÈå≤Èü≥</button>
                            <div id="stt-test-result" class="stt-test-result" style="display:none;"></div>
                        </div>
                    </div>

                    <!-- === Âè≥„Ç´„É©„É†: „Ç§„É≥„Çø„Éì„É•„ÉºÂÜÖÂÆπ === -->
                    <div class="settings-col">
                        <div class="section-title" data-i18n="section_content">üìù „Ç§„É≥„Çø„Éì„É•„ÉºÂÜÖÂÆπ</div>

                        <div class="form-group">
                            <label><span data-i18n="label_title">„Çø„Ç§„Éà„É´</span> <span style="color: #dc3545;">*</span></label>
                            <input type="text" id="title" placeholder="„Ç¢„Éó„É™ÈñãÁô∫„Å´Èñ¢„Åô„Çã„Ç§„É≥„Çø„Éì„É•„Éº" data-i18n-ph="ph_title" oninput="validateTitle()">
                        </div>

                        <div class="form-group">
                            <label>
                                <span data-i18n="label_context">‰∫ãÂâçÁü•Ë≠ò„ÉªÂèÇËÄÉË≥áÊñô</span>
                                <span id="char-count" class="char-counter">0 / 3000</span>
                            </label>
                            <textarea id="preContext" style="height: 80px;"
                                placeholder="„Ç§„É≥„Çø„Éì„É•„Éº„ÅÆÂâçÊèê„Å®„Å™„ÇãÁü•Ë≠ò„ÄÅÂèÇËÄÉ„ÉÜ„Ç≠„Çπ„Éà„ÄÅËá™Ë∫´„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´„Å™„Å©„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ" data-i18n-ph="ph_context"
                                oninput="validateCharCount()"></textarea>
                        </div>

                        <div class="form-group" style="flex:1; display:flex; flex-direction:column;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <span data-i18n="label_topics">ËÅû„Åç„Åü„ÅÑ„Åì„Å®„É™„Çπ„Éà</span>
                                <button type="button" class="btn-generate" onclick="generateTopics()" id="generateBtn">‚ú® „Çø„Ç§„Éà„É´„Åã„ÇâÁîüÊàê</button>
                                <span id="generate-status" style="font-size: 0.75em; color: #666;"></span>
                            </label>
                            <textarea id="topics" style="flex:1; min-height:100px;" placeholder="1. Ëá™Â∑±Á¥π‰ªã
2. „Å©„Çì„Å™„Ç¢„Éó„É™„ÇíÈñãÁô∫„Åó„Å¶„ÅÑ„Åæ„Åô„Åã
3. ËÇ≤Êàê„Éó„É≠„Ç∞„É©„É†„Å´ÂøúÂãü„Åó„Çà„ÅÜ„Å®ÊÄù„Å£„Åü„Åç„Å£„Åã„Åë
4. ËÇ≤Êàê„Éó„É≠„Ç∞„É©„É†„ÇíÁµåÈ®ì„Åó„Å¶„Å©„ÅÜ„Åß„Åó„Åü„ÅãÔºü
5. „Ç¢„Éó„É™„ÅÆ‰ªäÂæå„ÅØÔºü
6. Êù•Âπ¥Â∫¶ÂøúÂãü„Åô„Çã„ÇØ„É™„Ç®„Éº„Çø„Å∏„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏"></textarea>
                        </div>

                        <button id="startBtn" class="btn" onclick="saveAndStart()" disabled data-i18n="btn_start">ÈñãÂßã„Åô„Çã</button>
                        <p id="start-help" class="help-text" style="text-align:center; color:#dc3545;">‚ÄªAPI„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                    </div>

                </div>
            </div>
        </div>

        <!-- ===== ‰∏ãÊÆµ: Â±•Ê≠¥ (2„Éö„Ç§„É≥) ===== -->
        <div class="bottom-pane">

            <!-- Â∑¶: Â±•Ê≠¥‰∏ÄË¶ß -->
            <div class="col">
                <div class="col-header" data-i18n="history_header">üóÇ „Ç§„É≥„Çø„Éì„É•„ÉºÂ±•Ê≠¥</div>
                <div class="col-content">
                    <div id="history-list">
                        <div style="text-align:center; color:#999; margin-top:20px;">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                    </div>
                </div>
            </div>

            <!-- Âè≥: Â±•Ê≠¥Ë©≥Á¥∞ -->
            <div class="col">
                <div class="col-header" id="detail-header-bar" data-i18n="detail_header">üìÑ Ë©≥Á¥∞</div>
                <div class="col-content">
                    <div id="history-detail">
                        <div class="detail-placeholder">
                            <div class="detail-placeholder-icon">üëà</div>
                            <div>Â±•Ê≠¥„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <script src="i18n.js"></script>
    <script src="lang/ja.js"></script>
    <script src="lang/en.js"></script>
    <script src="lang/de.js"></script>
    <script>
        // AI‰∫∫Ê†º„Éó„É≠„É≥„Éó„ÉàÂÆöÁæ©
        const PERSONA_PROMPTS = {
            listener: `Act as an empathetic, highly skilled listener-interviewer focused on drawing out my honest feelings, values, and unspoken motives. Your goal is to make me feel safe enough to speak candidly while still clarifying my thinking.
Rules:
- You must reply in Japanese only.
- Ask exactly one open-ended question at a time.
- Always reflect my key words briefly (paraphrase in 1‚Äì2 sentences) before asking the next question.
- Build directly on my previous answer; do not change topics abruptly.
- Prioritize "why it matters to me," emotions, and decision-making context.
- When I seem vague, ask gently for a concrete example ("one specific episode, in time order").
Forbidden: judging me, giving advice too early, debating, or concluding on my behalf.
Close: When I say "„Åæ„Å®„ÇÅ„Å¶" or when the interview seems complete, summarize my core points as (1) feelings, (2) values, (3) constraints, (4) what I truly want, and ask if the summary is accurate.`,

            energetic: `Act as an energetic, upbeat interviewer who hypes me up and draws out vivid stories, excitement, and memorable moments. Your goal is to increase momentum and help me talk more freely and concretely.
Rules:
- You must reply in Japanese only.
- Ask exactly one question at a time, preferably open-ended.
- React with positive energy in a short line, then ask the next question.
- Always build on my previous answer and dig for scenes, emotions, and details.
- Frequently ask for "the best moment," "the turning point," or "a specific scene you can replay."
- Encourage quick scales when helpful (e.g., "„ÉÜ„É≥„Ç∑„Éß„É≥„Çí10ÊÆµÈöé„Åß") but keep it light.
Forbidden: long lectures, strict cross-examination, negativity that shuts me down.
Close: After several turns, offer a punchy 3-bullet recap of highlights and ask which part to expand next.`,

            analytical: `Act as a calm, analytical interviewer who systematically digs into assumptions, causes, constraints, and evidence. Your goal is to transform my statements into clear, testable understanding.
Rules:
- You must reply in Japanese only.
- Ask exactly one question at a time.
- Always tie the next question to my previous answer.
- Push for precision: definitions, time order, actors, constraints, metrics, and counterexamples.
- Prefer questions that clarify: "what exactly," "under what conditions," "how do you know," "what would disprove it."
- If I give abstractions, request one concrete example and one measurable indicator.
Forbidden: emotional judgment, unnecessary hype, making up facts, concluding without evidence.
Close: When enough info is gathered, summarize as: (1) claim, (2) evidence, (3) assumptions, (4) risks/unknowns, (5) next verification step, and ask for confirmation.`,

            critical: `Act as a polite but critical interviewer (a "soft reviewer") who stress-tests my claims for weaknesses, inconsistencies, bias, and missing evidence. Your goal is constructive scrutiny, not personal attack.
Rules:
- You must reply in Japanese only.
- Ask exactly one question at a time.
- Always refer to my previous answer and probe its vulnerable point.
- Focus criticism on statements and evidence, never on me as a person.
- Frequently ask: alternative explanations, unfair comparisons, edge cases, and what might be wrong.
- If I sound overly confident, ask "what would change your mind" or "what would be a strong counterargument."
Forbidden: sarcasm, ridicule, ad hominem, endless nitpicking without purpose.
Close: After several turns, list the top 3 concerns as questions, then ask which one we should resolve first.`,

            editor: `Act as an editor-interviewer who structures messy conversation into a clear narrative and actionable decisions. Your goal is to produce an accurate, agreed-upon summary and next steps.
Rules:
- You must reply in Japanese only.
- Ask exactly one question at a time.
- After every 2‚Äì3 answers from me, provide a brief structured recap (no new information).
- Keep forcing clarity: prioritize, define terms, separate facts vs opinions, and confirm scope (what can be shared).
- Drive toward outputs: conclusion, key bullets, and next actions.
Forbidden: adding details I didn't say, exaggeration, changing meaning, pushing your own agenda.
Close: End with a final summary in this format: (1)Ë¶ÅÁÇπ3„Å§, (2)ÂâçÊèê/Âà∂Á¥Ñ, (3)Êú™Á¢∫ÂÆö‰∫ãÈ†Ö, (4)Ê¨°„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥, (5)ÂÖ¨ÈñãÂèØÂê¶/ÁØÑÂõ≤, then ask "„Åì„ÅÆË¶ÅÁ¥Ñ„ÅßÊ≠£„Åó„ÅÑ„Åã".`
        };

        const PERSONA_LABELS = {
            listener: 'üéß ÂÇæËÅ¥Âûã',
            energetic: 'üé§ Áõõ„Çä‰∏ä„ÅíÂûã',
            analytical: 'üîç Ê∑±Êéò„ÇäÂûã',
            critical: 'üìù „ÉÅ„Çß„ÉÉ„ÇØÂûã',
            editor: 'üìã Ë¶ÅÁ¥ÑÂûã'
        };

        // „É¢„Éá„É´„É™„Çπ„ÉàÔºàÊÆãÈáè„ÉÅ„Çß„ÉÉ„ÇØÁî®Ôºâ
        const MODEL_IDS = [
            'llama-3.1-8b-instant',
            'openai/gpt-oss-20b',
            'meta-llama/llama-4-maverick-17b-128e-instruct',
            'meta-llama/llama-4-scout-17b-16e-instruct',
            'qwen/qwen3-32b',
            'llama-3.3-70b-versatile',
            'openai/gpt-oss-120b',
            'moonshotai/kimi-k2-instruct-0905'
        ];

        function getSelectedModel() {
            return document.querySelector('input[name="modelName"]:checked')?.value || 'llama-3.1-8b-instant';
        }

        function formatNum(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return Math.round(n / 1000) + 'K';
            return n.toLocaleString();
        }

        async function checkRateLimits() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                alert(I18N.t('alert_api_key_required'));
                return;
            }

            const btn = document.getElementById('checkLimitsBtn');
            const statusEl = document.getElementById('limits-status');
            btn.disabled = true;
            statusEl.innerText = I18N.t('status_rate_checking');

            MODEL_IDS.forEach((_, i) => {
                const el = document.getElementById(`limit-${i}`);
                if (el) el.innerHTML = '‚è≥';
            });

            const results = await Promise.allSettled(
                MODEL_IDS.map(async (modelId) => {
                    try {
                        const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: JSON.stringify({
                                model: modelId,
                                messages: [{ role: "user", content: "hi" }],
                                max_tokens: 1
                            })
                        });
                        return {
                            ok: res.ok,
                            status: res.status,
                            remainingRequests: res.headers.get('x-ratelimit-remaining-requests'),
                            limitRequests: res.headers.get('x-ratelimit-limit-requests'),
                            remainingTokens: res.headers.get('x-ratelimit-remaining-tokens'),
                            limitTokens: res.headers.get('x-ratelimit-limit-tokens'),
                        };
                    } catch (e) {
                        return { ok: false, status: 0, error: e.message };
                    }
                })
            );

            results.forEach((result, i) => {
                const el = document.getElementById(`limit-${i}`);
                if (!el) return;

                if (result.status === 'fulfilled' && result.value.ok) {
                    const r = result.value;
                    if (r.remainingRequests !== null) {
                        const remaining = parseInt(r.remainingRequests);
                        const limit = parseInt(r.limitRequests);
                        const pct = limit > 0 ? remaining / limit : 0;
                        const color = pct > 0.5 ? '#28a745' : pct > 0.1 ? '#e67e22' : '#dc3545';
                        el.innerHTML = `<span style="color:${color};font-weight:bold;">${formatNum(remaining)}</span><span style="color:#aaa;">/${formatNum(limit)}</span>`;
                    } else {
                        el.innerHTML = '<span style="color:#28a745;">‚úÖ</span>';
                    }
                } else if (result.status === 'fulfilled' && result.value.status === 429) {
                    el.innerHTML = `<span style="color:#dc3545;font-weight:bold;">${I18N.t('status_rate_limited')}</span>`;
                } else if (result.status === 'fulfilled') {
                    el.innerHTML = `<span style="color:#999;" title="HTTP ${result.value.status}">N/A</span>`;
                } else {
                    el.innerHTML = '<span style="color:#dc3545;">‚ùå</span>';
                }
            });

            btn.disabled = false;
            statusEl.innerText = '';
        }

        // ÈÅ∏Êäû„Åï„Çå„Åü‰∫∫Ê†º„Çø„Ç§„Éó„ÇíÂèñÂæó
        function getSelectedPersonaType() {
            return document.querySelector('input[name="personaType"]:checked')?.value || 'listener';
        }

        // ÈÅ∏Êäû„Åï„Çå„Åü‰∫∫Ê†º„ÅÆ„Éó„É≠„É≥„Éó„Éà„ÇíÂèñÂæóÔºàI18NÂØæÂøúÔºâ
        function getSelectedPersonaPrompt() {
            const type = getSelectedPersonaType();
            return I18N.t(`persona_${type}_prompt`);
        }

        // ‰∫∫Ê†º„É©„Éô„É´„ÇíÂèñÂæóÔºàI18NÂØæÂøúÔºâ
        function getPersonaLabel(type) {
            return I18N.t(`persona_${type}_label`);
        }

        let isApiValid = false;
        let isCharValid = true;
        let isTitleValid = false;
        const MAX_CHARS = 3000;

        const DB_NAME = "InterviewDB";
        const DB_VERSION = 1;
        const STORE_NAME = "archives";

        // --- ÊñáÂ≠óÊï∞„Éê„É™„Éá„Éº„Ç∑„Éß„É≥ ---
        function validateCharCount() {
            const text = document.getElementById('preContext').value;
            const count = text.length;
            const counterEl = document.getElementById('char-count');

            counterEl.innerText = `${count} / ${MAX_CHARS}`;

            if (count > MAX_CHARS) {
                counterEl.classList.add('char-over');
                isCharValid = false;
            } else {
                counterEl.classList.remove('char-over');
                isCharValid = true;
            }
            updateStartButton();
        }

        // --- „Çø„Ç§„Éà„É´„Éê„É™„Éá„Éº„Ç∑„Éß„É≥ ---
        function validateTitle() {
            const title = document.getElementById('title').value.trim();
            isTitleValid = title.length > 0;
            updateStartButton();
        }

        // --- API Validation ---
        async function validateApi() {
            const key = document.getElementById('apiKey').value.trim();
            const statusEl = document.getElementById('api-status');

            if (!key) {
                statusEl.innerText = "";
                isApiValid = false;
                updateStartButton();
                return;
            }

            statusEl.className = "status-indicator status-loading";
            statusEl.innerText = I18N.t('status_checking');

            try {
                const res = await fetch("https://api.groq.com/openai/v1/models", {
                    headers: { "Authorization": `Bearer ${key}` }
                });

                if (res.ok) {
                    statusEl.className = "status-indicator status-ok";
                    statusEl.innerText = I18N.t('status_valid');
                    isApiValid = true;
                } else {
                    statusEl.className = "status-indicator status-err";
                    statusEl.innerText = I18N.t('status_invalid');
                    isApiValid = false;
                }
            } catch (e) {
                statusEl.className = "status-indicator status-err";
                statusEl.innerText = I18N.t('status_error_short');
                isApiValid = false;
            }
            updateStartButton();
        }

        function updateStartButton() {
            const btn = document.getElementById('startBtn');
            const help = document.getElementById('start-help');

            const ready = isApiValid && isTitleValid && isCharValid;

            btn.disabled = !ready;

            if (!isApiValid) {
                help.innerText = I18N.t('help_api_key');
                help.style.display = 'block';
            } else if (!isTitleValid) {
                help.innerText = I18N.t('help_title_required');
                help.style.display = 'block';
            } else if (!isCharValid) {
                help.innerText = I18N.t('help_char_over');
                help.style.display = 'block';
            } else {
                help.style.display = 'none';
            }
        }

        // --- „Éà„Éî„ÉÉ„ÇØËá™ÂãïÁîüÊàê ---
        async function generateTopics() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const title = document.getElementById('title').value.trim();
            const personaType = getSelectedPersonaType();
            const personaLabel = getPersonaLabel(personaType);
            const modelName = getSelectedModel();

            if (!apiKey) {
                alert(I18N.t('alert_api_key_required'));
                return;
            }
            if (!title) {
                alert(I18N.t('alert_title_required'));
                return;
            }

            const btn = document.getElementById('generateBtn');
            const statusEl = document.getElementById('generate-status');

            btn.disabled = true;
            statusEl.innerText = I18N.t('status_generating');

            const systemPrompt = I18N.t('topic_gen_system').replace('{personaLabel}', personaLabel);
            const userPrompt = I18N.t('topic_gen_user').replace('{title}', title);

            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: modelName,
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: userPrompt }
                        ],
                        temperature: 0.7,
                        max_tokens: 1024
                    })
                });

                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    throw new Error(err.error?.message || response.statusText);
                }

                const data = await response.json();
                const generatedText = data.choices[0].message.content;

                document.getElementById('topics').value = generatedText;
                statusEl.innerText = I18N.t('status_generated');
                setTimeout(() => { statusEl.innerText = ''; }, 2000);

            } catch (e) {
                console.error('Generate Error:', e);
                statusEl.innerText = I18N.t('status_error_short');
                alert(I18N.t('alert_generate_failed') + e.message);
            } finally {
                btn.disabled = false;
            }
        }

        // --- Ë®≠ÂÆö‰øùÂ≠ò„Å®ÈñãÂßã ---
        function saveAndStart() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) return alert(I18N.t('alert_api_key_required'));

            if (document.getElementById('saveApiKey').checked) {
                localStorage.setItem('groqApiKey', apiKey);
            } else {
                localStorage.removeItem('groqApiKey');
            }

            const config = {
                apiKey: apiKey,
                modelName: getSelectedModel(),
                title: document.getElementById('title').value,
                context: document.getElementById('preContext').value,
                topics: document.getElementById('topics').value.split('\n').filter(line => line.trim() !== ''),
                depth: document.querySelector('input[name="depth"]:checked').value,
                voiceName: document.getElementById('voiceName').value,
                rate: parseFloat(document.getElementById('rate').value),
                pitch: 1.0,
                volume: 1.0,
                personaType: getSelectedPersonaType(),
                persona: getSelectedPersonaPrompt(),
                sttMode: document.querySelector('input[name="sttMode"]:checked').value,
                language: I18N.currentLang
            };

            localStorage.setItem('interviewConfig', JSON.stringify(config));
            window.location.href = 'interview_app.html';
        }

        // --- Èü≥Â£∞Èñ¢ÈÄ£ ---
        function populateVoiceList() {
            if (typeof speechSynthesis === 'undefined') return;
            const voices = speechSynthesis.getVoices();
            const voiceSelect = document.getElementById('voiceName');
            const langCode = I18N.speechLang.split('-')[0]; // 'ja', 'en', 'de'
            const langRegion = I18N.speechLang.split('-')[1] || ''; // 'JP', 'US', 'DE'
            const filteredVoices = voices.filter(v => v.lang.includes(langCode) || (langRegion && v.lang.includes(langRegion)));
            voiceSelect.innerHTML = '';
            if (filteredVoices.length === 0) {
                const option = document.createElement('option');
                option.text = I18N.t('no_voice_available');
                voiceSelect.add(option); return;
            }
            filteredVoices.forEach((voice) => {
                const option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.value = voice.name;
                if (voice.name.includes('Google') && voice.lang.startsWith(langCode)) option.selected = true;
                voiceSelect.appendChild(option);
            });
        }
        populateVoiceList();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = populateVoiceList;
        }

        // ‰øùÂ≠ò„Åï„Çå„ÅüAPI„Ç≠„Éº„ÇíË™≠„ÅøËæº„ÇÄ
        (function loadSavedApiKey() {
            const savedKey = localStorage.getItem('groqApiKey');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
                document.getElementById('saveApiKey').checked = true;
                validateApi();
            }
        })();

        // STT„É¢„Éº„ÉâÂàáÊõøÊôÇ„ÅÆ„Éò„É´„ÉóË°®Á§∫
        document.querySelectorAll('input[name="sttMode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const help = document.getElementById('stt-help');
                if (this.value === 'groq') {
                    help.innerHTML = I18N.t('stt_help_groq');
                } else {
                    help.innerHTML = I18N.t('stt_help_webspeech');
                }
            });
        });

        // ‰øùÂ≠ò„Åï„Çå„ÅüSTT„É¢„Éº„Éâ„ÇíÂæ©ÂÖÉ
        (function loadSavedSttMode() {
            const saved = localStorage.getItem('interviewConfig');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    if (config.sttMode) {
                        const radio = document.querySelector(`input[name="sttMode"][value="${config.sttMode}"]`);
                        if (radio) {
                            radio.checked = true;
                            radio.dispatchEvent(new Event('change'));
                        }
                    }
                } catch(e) {}
            }
        })();

        function previewVoice() {
            const voiceName = document.getElementById('voiceName').value;
            const rate = parseFloat(document.getElementById('rate').value);
            if (!voiceName) return alert(I18N.t('alert_voice_not_loaded'));
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(I18N.t('voice_test_text'));
            utterance.rate = rate; utterance.volume = 1.0; utterance.pitch = 1.0;
            const voices = window.speechSynthesis.getVoices();
            const selectedVoice = voices.find(v => v.name === voiceName);
            if (selectedVoice) utterance.voice = selectedVoice;
            window.speechSynthesis.speak(utterance);
        }

        // --- STT „ÉÜ„Çπ„ÉàÈå≤Èü≥ ---
        async function testSTT() {
            const sttMode = document.querySelector('input[name="sttMode"]:checked').value;
            const resultEl = document.getElementById('stt-test-result');
            const btn = document.getElementById('stt-test-btn');
            resultEl.style.display = 'block';

            if (sttMode === 'webspeech') {
                // Web Speech API „ÉÜ„Çπ„Éà
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    resultEl.innerText = I18N.t('stt_no_support');
                    return;
                }
                resultEl.innerText = I18N.t('stt_test_speak');
                btn.disabled = true;

                const recognition = new SpeechRecognition();
                recognition.lang = I18N.speechLang;
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onresult = (event) => {
                    const text = event.results[0][0].transcript;
                    const confidence = (event.results[0][0].confidence * 100).toFixed(0);
                    resultEl.innerText = `‚úÖ "${text}" (‰ø°È†ºÂ∫¶: ${confidence}%)`;
                    btn.disabled = false;
                };
                recognition.onerror = (event) => {
                    if (event.error === 'no-speech') {
                        resultEl.innerText = I18N.t('stt_no_speech');
                    } else if (event.error === 'network') {
                        resultEl.innerText = I18N.t('stt_network_error');
                    } else {
                        resultEl.innerText = `‚ùå „Ç®„É©„Éº: ${event.error}`;
                    }
                    btn.disabled = false;
                };
                recognition.onend = () => {
                    if (resultEl.innerText.includes('üé§')) {
                        resultEl.innerText = I18N.t('stt_no_speech');
                    }
                    btn.disabled = false;
                };
                recognition.start();
            } else {
                // Groq Whisper „ÉÜ„Çπ„Éà
                const apiKey = document.getElementById('apiKey').value.trim();
                if (!apiKey) {
                    resultEl.innerText = '‚ùå API„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
                    return;
                }

                resultEl.innerText = I18N.t('stt_test_recording');
                btn.disabled = true;

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const mediaRecorder = new MediaRecorder(stream);
                    const chunks = [];

                    mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) chunks.push(e.data);
                    };

                    mediaRecorder.onstop = async () => {
                        stream.getTracks().forEach(t => t.stop());
                        const blob = new Blob(chunks, { type: mediaRecorder.mimeType });
                        resultEl.innerText = I18N.t('stt_test_transcribing');

                        try {
                            const ext = blob.type.includes('mp4') ? 'mp4' : blob.type.includes('ogg') ? 'ogg' : 'webm';
                            const formData = new FormData();
                            formData.append('file', blob, `test.${ext}`);
                            formData.append('model', 'whisper-large-v3-turbo');
                            formData.append('language', I18N.whisperLang);
                            formData.append('response_format', 'json');

                            const controller = new AbortController();
                            setTimeout(() => controller.abort(), 15000);

                            const res = await fetch('https://api.groq.com/openai/v1/audio/transcriptions', {
                                method: 'POST',
                                headers: { 'Authorization': `Bearer ${apiKey}` },
                                body: formData,
                                signal: controller.signal
                            });

                            if (!res.ok) throw new Error(`API Error: ${res.status}`);
                            const data = await res.json();
                            const text = data.text?.trim();
                            if (text) {
                                resultEl.innerText = `‚úÖ "${text}"`;
                            } else {
                                resultEl.innerText = I18N.t('stt_no_speech');
                            }
                        } catch (e) {
                            resultEl.innerText = `‚ùå „Ç®„É©„Éº: ${e.message}`;
                        }
                        btn.disabled = false;
                    };

                    mediaRecorder.start();
                    setTimeout(() => {
                        if (mediaRecorder.state === 'recording') {
                            mediaRecorder.stop();
                        }
                    }, 3000);
                } catch (e) {
                    resultEl.innerText = `‚ùå „Éû„Ç§„ÇØ„Ç¢„ÇØ„Çª„Çπ„Ç®„É©„Éº: ${e.message}`;
                    btn.disabled = false;
                }
            }
        }

        // --- DB & Â±•Ê≠¥Ë°®Á§∫ ---
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: "id" });
                };
                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        async function loadHistory() {
            const listEl = document.getElementById('history-list');

            try {
                const db = await openDB();
                const tx = db.transaction(STORE_NAME, "readonly");
                const store = tx.objectStore(STORE_NAME);
                const request = store.getAll();

                request.onsuccess = () => {
                    const records = request.result;
                    records.sort((a, b) => b.id - a.id);

                    if (records.length === 0) {
                        listEl.innerHTML = `
                        <div class="history-empty">
                            <div class="history-empty-icon">üì≠</div>
                            <div>${I18N.t('history_empty')}</div>
                            <div style="font-size: 0.85em; margin-top: 5px;">${I18N.t('history_empty_sub')}</div>
                        </div>`;
                        return;
                    }

                    listEl.innerHTML = `<div style="font-size: 0.8em; color: #666; margin-bottom: 8px;">${I18N.t('history_count').replace('${n}', records.length)}</div>`;
                    records.forEach(rec => {
                        const item = document.createElement('div');
                        item.className = 'history-item';
                        item.innerHTML = `<div class="history-date">${rec.date}</div><div class="history-title">${rec.title}</div>`;
                        item.onclick = () => {
                            document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active'));
                            item.classList.add('active');
                            showDetail(rec);
                        };
                        listEl.appendChild(item);
                    });
                };
            } catch (e) {
                console.error(e);
                listEl.innerHTML = I18N.t('db_error');
            }
        }

        // ÁèæÂú®ÈÅ∏Êäû‰∏≠„ÅÆ„É¨„Ç≥„Éº„Éâ„Çí‰øùÊåÅ
        let selectedRecord = null;

        function showDetail(rec) {
            selectedRecord = rec;
            const detailEl = document.getElementById('history-detail');
            const headerBar = document.getElementById('detail-header-bar');
            headerBar.innerText = `üìÑ ${rec.title}`;

            // AI„ÅÆÁô∫Ë®Ä„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíËøΩË∑°
            let aiResponseIndex = 0;

            const chatHtml = rec.history.map((h, idx) => {
                const role = h.role === 'assistant' ? 'ü§ñ AI' : (h.role === 'user' ? 'üë§ User' : h.role);
                const roleClass = h.role === 'assistant' ? 'chat-ai' : 'chat-user';
                const text = h.content;

                let promptBtn = '';
                if (h.role === 'assistant' && rec.promptLog && rec.promptLog.length > 0) {
                    const logEntry = rec.promptLog.find(log => log.aiResponseIndex === aiResponseIndex);
                    if (logEntry) {
                        const logIndex = rec.promptLog.indexOf(logEntry);
                        promptBtn = `<button class="btn-show-prompt" onclick="showPromptDetail(${logIndex})">üêõ „Éó„É≠„É≥„Éó„Éà</button>`;
                    }
                    aiResponseIndex++;
                }

                return `<div class="chat-row ${roleClass}"><div class="chat-role">${role}${promptBtn}</div><div>${text}</div></div>`;
            }).join('');

            // Ë®≠ÂÆöÊÉÖÂ†±„ÅÆHTML
            let settingsHtml = '';
            if (rec.settings) {
                const s = rec.settings;
                const topicsText = rec.topics && rec.topics.length > 0 ? rec.topics.join(' / ') : I18N.t('detail_unknown');
                const topicsDisplay = topicsText.length > 150 ? topicsText.substring(0, 150) + '...' : topicsText;
                settingsHtml = `
                <div class="detail-section-title">${I18N.t('detail_settings_title')}</div>
                <div class="settings-info">
                    <div class="setting-row"><span class="setting-label">${I18N.t('detail_model')}</span> ${s.modelName || I18N.t('detail_unknown')}</div>
                    <div class="setting-row"><span class="setting-label">${I18N.t('detail_depth')}</span> ${s.depth === 'deep' ? I18N.t('depth_deep') : I18N.t('depth_standard')}</div>
                    <div class="setting-row"><span class="setting-label">${I18N.t('detail_voice')}</span> ${s.voiceName || I18N.t('detail_unknown')}</div>
                    <div class="setting-row"><span class="setting-label">${I18N.t('detail_rate')}</span> ${s.rate || I18N.t('detail_unknown')}</div>
                    <div class="setting-row"><span class="setting-label">${I18N.t('detail_topics')}</span><div class="setting-text">${topicsDisplay}</div></div>
                    ${s.context ? `<div class="setting-row"><span class="setting-label">${I18N.t('detail_context')}</span><div class="setting-text">${s.context.substring(0, 200)}${s.context.length > 200 ? '...' : ''}</div></div>` : ''}
                    <div class="setting-row"><span class="setting-label">${I18N.t('detail_persona')}</span> ${s.personaType ? (getPersonaLabel(s.personaType) || s.personaType) : I18N.t('detail_unknown')}</div>
                </div>
                <button onclick="applySettings()" class="btn-apply-settings">${I18N.t('btn_apply_settings')}</button>
            `;
            }

            detailEl.innerHTML = `
            <div class="detail-header">
                <div class="detail-title">${rec.title}</div>
                <div class="detail-meta">${rec.date}</div>
                <button onclick="deleteRecord(${rec.id})" class="btn-delete">${I18N.t('btn_delete')}</button>
            </div>
            ${settingsHtml}
            <div class="detail-section-title">${I18N.t('detail_summary')}</div>
            <div class="detail-summary">${rec.summary}</div>
            <button onclick="navigator.clipboard.writeText(\`${rec.summary.replace(/`/g, '\\`')}\`)" style="margin-top:5px; padding:5px; font-size:0.8em; cursor:pointer;">${I18N.t('btn_copy')}</button>
            <div class="detail-section-title">${I18N.t('detail_chat_log')} (${rec.history.length} ${I18N.t('detail_turns')})</div>
            <div class="detail-chat">${chatHtml}</div>
        `;
        }

        async function deleteRecord(id) {
            if (!confirm(I18N.t('confirm_delete'))) {
                return;
            }
            try {
                const db = await openDB();
                const tx = db.transaction(STORE_NAME, "readwrite");
                const store = tx.objectStore(STORE_NAME);
                store.delete(id);
                tx.oncomplete = () => {
                    selectedRecord = null;
                    // Ë©≥Á¥∞„Çí„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„Å´Êàª„Åô
                    const detailEl = document.getElementById('history-detail');
                    const headerBar = document.getElementById('detail-header-bar');
                    headerBar.innerText = I18N.t('detail_header');
                    detailEl.innerHTML = `
                        <div class="detail-placeholder">
                            <div class="detail-placeholder-icon">üëà</div>
                            <div>${I18N.t('detail_select')}</div>
                        </div>`;
                    loadHistory();
                    alert(I18N.t('alert_deleted'));
                };
            } catch (e) {
                console.error("Delete Error:", e);
                alert(I18N.t('alert_delete_failed'));
            }
        }

        function applySettings() {
            if (!selectedRecord || !selectedRecord.settings) {
                alert(I18N.t('alert_no_settings'));
                return;
            }
            const s = selectedRecord.settings;
            const rec = selectedRecord;

            // „Éï„Ç©„Éº„É†„Å´Ë®≠ÂÆö„ÇíÂèçÊò†
            document.getElementById('title').value = rec.title || '';
            document.getElementById('preContext').value = s.context || '';
            document.getElementById('topics').value = rec.topics ? rec.topics.join('\n') : '';

            // AI‰∫∫Ê†ºÈÅ∏Êäû
            if (s.personaType) {
                const personaRadio = document.querySelector(`input[name="personaType"][value="${s.personaType}"]`);
                if (personaRadio) personaRadio.checked = true;
            }

            // „É¢„Éá„É´ÈÅ∏Êäû
            if (s.modelName) {
                const modelRadio = document.querySelector(`input[name="modelName"][value="${s.modelName}"]`);
                if (modelRadio) modelRadio.checked = true;
            }

            // Ê∑±„Åï
            if (s.depth) {
                const depthRadio = document.querySelector(`input[name="depth"][value="${s.depth}"]`);
                if (depthRadio) depthRadio.checked = true;
            }

            // Èü≥Â£∞Ôºà„É™„Çπ„Éà„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„ÇãÂ†¥ÂêàÔºâ
            const voiceSelect = document.getElementById('voiceName');
            if (s.voiceName) {
                for (let opt of voiceSelect.options) {
                    if (opt.value === s.voiceName) {
                        opt.selected = true;
                        break;
                    }
                }
            }

            // ÈÄüÂ∫¶
            if (s.rate) {
                document.getElementById('rate').value = s.rate;
                document.getElementById('rateVal').innerText = s.rate;
            }

            // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥Êõ¥Êñ∞
            validateCharCount();
            validateTitle();

            alert(I18N.t('alert_settings_applied'));
        }

        loadHistory();

        // „Éó„É≠„É≥„Éó„ÉàË°®Á§∫„É¢„Éº„ÉÄ„É´Èñ¢ÈÄ£
        function showPromptDetail(logIndex) {
            if (!selectedRecord || !selectedRecord.promptLog || !selectedRecord.promptLog[logIndex]) {
                alert(I18N.t('prompt_not_found'));
                return;
            }

            const log = selectedRecord.promptLog[logIndex];
            const modal = document.getElementById('prompt-modal');
            const body = document.getElementById('prompt-modal-body');

            const messagesHtml = log.messages
                .filter(m => m.role !== 'system')
                .map(m => `<div style="margin-bottom: 5px;"><strong style="color: ${m.role === 'user' ? '#ff6b6b' : '#98fb98'};">${m.role}:</strong> ${escapeHtml(m.content.substring(0, 200))}${m.content.length > 200 ? '...' : ''}</div>`)
                .join('');

            body.innerHTML = `
                <div class="prompt-section">
                    <div class="prompt-section-title">üìÖ „Çø„Ç§„É†„Çπ„Çø„É≥„Éó: ${log.timestamp}</div>
                </div>
                <div class="prompt-section">
                    <div class="prompt-section-title">üì° „Çπ„ÉÜ„Éº„Çø„Çπ: ${log.status}</div>
                </div>
                <div class="prompt-section">
                    <div class="prompt-section-title">üìú System Prompt:</div>
                    <div class="prompt-content">${escapeHtml(log.systemPrompt)}</div>
                </div>
                <div class="prompt-section">
                    <div class="prompt-section-title">üí¨ ÈÄÅ‰ø°„Åó„Åü‰ºöË©±Â±•Ê≠¥ (${log.messages.filter(m => m.role !== 'system').length}„É°„ÉÉ„Çª„Éº„Ç∏):</div>
                    <div class="prompt-content prompt-messages">${messagesHtml || '(„Å™„Åó)'}</div>
                </div>
                ${log.response ? `
                <div class="prompt-section">
                    <div class="prompt-section-title">ü§ñ AI„ÅÆÂøúÁ≠î:</div>
                    <div class="prompt-content response">${escapeHtml(log.response)}</div>
                </div>
                ` : ''}
            `;

            modal.classList.add('active');
        }

        function closePromptModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('prompt-modal').classList.remove('active');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ESC„Ç≠„Éº„Åß„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closePromptModal();
            }
        });

        // === I18N initialization ===
        function renderLangSelector() {
            const container = document.getElementById('lang-selector');
            if (!container) return;
            container.innerHTML = I18N.available().map(lang =>
                `<button class="lang-btn ${lang.code === I18N.currentLang ? 'active' : ''}" data-lang="${lang.code}" onclick="I18N.setLanguage('${lang.code}')">${lang.flag} ${lang.name}</button>`
            ).join('');
        }

        // Language change handler
        window.addEventListener('languageChanged', (e) => {
            document.title = I18N.t('setup_page_title');
            renderLangSelector();
            populateVoiceList();
            loadHistory();
            updateStartButton();
            // Update STT help text
            const sttMode = document.querySelector('input[name="sttMode"]:checked').value;
            const help = document.getElementById('stt-help');
            if (sttMode === 'groq') {
                help.innerHTML = I18N.t('stt_help_groq');
            } else {
                help.innerHTML = I18N.t('stt_help_webspeech');
            }
        });

        // Initialize I18N
        I18N.init();
        renderLangSelector();
        document.title = I18N.t('setup_page_title');
    </script>

</body>

</html>
